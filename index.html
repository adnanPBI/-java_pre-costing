<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Pre-Costing Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/md5-js@0.0.3/md5.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	
	
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .calculator-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .section-header {
            background-color: #2980b9;
            color: white;
            padding: 10px;
            border-radius: 5px 5px 0 0;
            margin-bottom: 15px;
        }
        .table-responsive {
            margin-bottom: 20px;
        }
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.5);
        }
        .result-field {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .pattern-row input {
            width: 100%;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        #loginModal .modal-content {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="header-controls">
            <h1 class="me-3">Pre-costing Form</h1>
            <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i> Search Costing</button>
            <select class="form-select" style="width: 400px;" id="preCostingDropdown">
                <option value="">Select Pre-costing No</option>
            </select>
            <button class="btn btn-success" id="saveToPostgreSQLBtn"><i class="fas fa-database"></i> Save to PostgreSQL</button>
            <button class="btn btn-info" id="exportToCSVBtn"><i class="fas fa-file-csv"></i> Export to CSV</button>
            <button class="btn btn-secondary" id="exportToSQLBtn"><i class="fas fa-file-code"></i> Export to SQL</button>
            <button class="btn btn-success" id="saveBtn"><i class="fas fa-save"></i> Save</button>
			<button class="btn btn-info" id="loadBtn"><i class="fas fa-folder"></i> Load</button>
            <button class="btn btn-danger" id="clearBtn"><i class="fas fa-trash"></i> Clear</button>
			<button class="btn btn-warning" id="resetBtn"><i class="fas fa-undo"></i> Reset</button>
            
        </div>

        <!-- Login Modal -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalLabel">Login</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="passwordInput" class="form-label">Password</label>
                            <input type="password" class="form-control" id="passwordInput">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="loginBtn">Login</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Load Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" aria-labelledby="loadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadModalLabel">Load Pre-Costing Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="loadJsonFile" class="form-label">Load from JSON File</label>
                    <input type="file" class="form-control" id="loadJsonFile" accept=".json">
                </div>
                <h6>Saved in Session</h6>
                <ul class="list-group" id="loadList"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
        <!-- Basic Information -->
        <div class="section-header">Basic Information</div>
        <div class="row mb-3">
            <div class="col-md-4"><label>Pre Costing No:</label><input type="text" class="form-control" id="preCostingNo" maxlength="8" pattern="\d{1,8}" placeholder="Enter Pre-Costing No" value="M=2"></div>
            <div class="col-md-4"><label>Buyer:</label><input type="text" class="form-control" id="buyer" value="madam"></div>
            <div class="col-md-4"><label>Construction:</label><input type="text" class="form-control" id="construction" value="40x40/120x80"></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4"><label>Warp EPI:</label><input type="number" class="form-control" id="epi" value="120"></div>
            <div class="col-md-4"><label>Weft PPI:</label><input type="number" class="form-control" id="ppi" value="80"></div>
            <div class="col-md-4">
      <label>Weave Type:</label>
      <select class="form-control" id="weaveType">
         <option value="Plain">Plain</option>
         <option value="Oxford">Oxford</option>
         <option value="Ottoman">Ottoman</option>
         <option value="Matt">Matt</option>
         <option value="2/1 Twill">2/1 Twill</option>
         <option value="2/2 Twill">2/2 Twill</option>
         <option value="3/1 Twill">3/1 Twill</option>
         <option value="4/1 Satin">4/1 Satin</option>
         <option value="3/2 Twill">3/2 Twill</option>
         <option value="3/3 Twill">3/3 Twill</option>
         <option value="3/3 Matt">3/3 Matt</option>
         <option value="3/2 Matt">3/2 Matt</option>
         <option value="4/4 Twill">4/4 Twill</option>
         <option value="4/2 Twill">4/2 Twill</option>
         <option value="6/2 Twill">6/2 Twill</option>
         <option value="2/2 Oxford Twill">2/2 Oxford Twill</option>
         <option value="3/1 Oxford Twill">3/1 Oxford Twill</option>
         <option value="2/1 Matt Twill">2/1 Matt Twill</option>
         <option value="2/2 Matt Twill">2/2 Matt Twill</option>
         <option value="3/1 Matt Twill">3/1 Matt Twill</option>
         <option value="3/3 Matt Twill">3/3 Matt Twill</option>
         <option value="4/4 Matt Twill">4/4 Matt Twill</option>
         <option value="Dobby">Dobby</option>
      </select>
   </div>
        </div>

        <!-- Dimensions and Specifications -->
        <div class="section-header">Dimensions & Specifications</div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Finish Width (in):</label><input type="number" class="form-control" id="finishWidth" value="57"></div>
            <div class="col-md-3"><label>Greige Width (in):</label><input type="number" class="form-control" id="greigeWidth" value="64"></div>
            <div class="col-md-3"><label>Total Ends:</label><input type="number" class="form-control" id="totalEnds" value="3876"></div>
            <div class="col-md-3"><label>Warp Crimp (%):</label><input type="number" class="form-control" id="warpCrimp" value="11"></div>
            <div class="col-md-3"><label>Weft Crimp (%):</label><input type="number" class="form-control" id="weftCrimp" value="11"></div>
        </div>

        <!-- Wastage and Allowances -->
        <div class="section-header">Wastage & Allowances</div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Y/D Allow (%):</label><input type="number" class="form-control" id="ydAllow" value="3"></div>
            <div class="col-md-3"><label>Warp Waste (%):</label><input type="number" class="form-control" id="warpWast" value="1.2"></div>
            <div class="col-md-3"><label>Weft Waste (%):</label><input type="number" class="form-control" id="weftWast" value="1"></div>
            <div class="col-md-3"><label>Finish Allow (%):</label><input type="number" class="form-control" id="finishAllow" value="7"></div>
        </div>

        <!-- Cost Parameters -->
        <div class="section-header">Cost Parameters</div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Weaving Rate ($/yd):</label><input type="number" class="form-control" id="weavingPickRate" value="0.45"></div>
            <div class="col-md-3"><label>Dye/Finish Rate ($):</label><input type="number" class="form-control" id="dyeingFinishingRate" value="30"></div>
            <div class="col-md-3"><label>Commercial Cost ($):</label><input type="number" class="form-control" id="commercialCostInput" value="3"></div>
            <div class="col-md-3"><label>Profit:</label><input type="number" class="form-control" id="profit" value="5"></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Order Quantity (yds):</label><input type="number" class="form-control" id="orderQuantity" value="3000"></div>
            <div class="col-md-3"><label>Reed Space:</label><input type="number" class="form-control" id="reedSpace" value="60"></div>
            <div class="col-md-3"><label>Pick Length (Inch):</label><input type="number" class="form-control" id="pickLength" value="70"></div>
            <div class="col-md-3"><label>Dollar Rate in TK:</label><input type="number" class="form-control" id="dollarRateTk" value="108.5"></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Pre-costing Date:</label><input type="date" class="form-control" id="preCostingDate" value="2025-03-01"></div>
        </div>

        <!-- Warp & Weft pattern calculation -->
        <div class="section-header">Warp & Weft pattern details</div>
        <div class="row mb-3">
            <div class="col-md-6"><label>Warp Repeat Size (Inch):</label><input type="number" class="form-control result-field" id="warpRepeatSize" readonly></div>
            <div class="col-md-6"><label>Weft Repeat Size (Inch):</label><input type="number" class="form-control result-field" id="weftRepeatSize" readonly></div>
            <div class="col-md-6"><label>Warp Repeat Number:</label><input type="number" class="form-control result-field" id="warpRepeatNumber" readonly></div>
            <div class="col-md-6"><label>Weft Repeat Number:</label><input type="number" class="form-control result-field" id="weftRepeatNumber" readonly></div>
            <div class="col-md-6"><label>Warp Repeat Ends:</label><input type="number" class="form-control result-field" id="warpRepeatEnds" readonly></div>
        </div>

        <!-- Warp Details -->
        <div class="section-header">Warp Details</div>
        <div class="table-responsive">
            <table class="table table-bordered" id="warpCalculationTable">
                <thead>
                    <tr>
                        <th>Warp Count</th>
                        <th>Repeat Brkdwn (Inch)</th>
                        <th>Color_Name(s)</th>
                        <th>Denting</th>
                        <th>Rate (tk/lbs)</th>
                        <th>Y/Dye Cost/kg</th>
                        <th>Repeat Ends / Color</th>
                        <th>Pattern Total Ends</th>
                        <th>Dents in Full Width</th>
                        <th>Greige Yn Rate/kg</th>
                        <th>Consumption (kg/yd)</th>
                        <th>Raw Yarn Cost / yd</th>
                        <th>Y/Dye Cost / yd</th>
                        <th>Warp total cost</th>
                        <th>Required Greige Warp (kg)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="pattern-row">
                        <td><input type="number" class="form-control" value="20"></td>
                        <td><input type="number" class="form-control" value="2"></td>
                        <td><input type="text" class="form-control" value="White"></td>
                        <td><input type="number" class="form-control" value="2"></td>
                        <td><input type="number" class="form-control" value="142"></td>
                        <td><input type="number" class="form-control" value="150"></td>
                        <td><input type="number" class="form-control" value="5"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr><td colspan="16"><button class="btn btn-sm btn-primary add-warp-row"><i class="fas fa-plus"></i> Add Warp Pattern</button></td></tr>
                </tfoot>
            </table>
        </div>

        <!-- Weft Details -->
        <div class="section-header">Weft Details</div>
        <div class="table-responsive">
            <table class="table table-bordered" id="weftCalculationTable">
                <thead>
                    <tr>
                        <th>Weft Count</th>
                        <th>Repeat Brkdwn (Inch)</th>
                        <th>Color_Names</th>
                        <th>Pick Density</th>
                        <th>Rate (tk/lbs)</th>
                        <th>Y/Dyeing Cost/kg</th>
                        <th>Repeat Picks / Color</th>
                        <th>Pattern Total Picks</th>
                        <th>Greige Yarn Rate/kg</th>
                        <th>Consumption (kg/yd)</th>
                        <th>Yarn Cost</th>
                        <th>Color Cost</th>
                        <th>Weft total cost</th>
                        <th>Required Greige Weft (kg)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="pattern-row">
                        <td><input type="number" class="form-control" value="20"></td>
                        <td><input type="number" class="form-control" value="2"></td>
                        <td><input type="text" class="form-control" value="White"></td>
                        <td><input type="number" class="form-control" value="54"></td>
                        <td><input type="number" class="form-control" value="142"></td>
                        <td><input type="number" class="form-control" value="150"></td>
                        <td><input type="number" class="form-control" value="4"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td class="result-cell"></td>
                        <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr><td colspan="15"><button class="btn btn-sm btn-primary add-weft-row"><i class="fas fa-plus"></i> Add Weft Pattern</button></td></tr>
                </tfoot>
            </table>
        </div>

        <!-- Total Pre-costing Values -->
        <div class="section-header">Total Pre-costing Values</div>
        <div class="row mb-3">
            <div class="col-md-6"><label>Total Pre-cost in Taka:</label><input type="number" class="form-control result-field" id="totalPreCostTk" readonly></div>
            <div class="col-md-6"><label>Total Pre-cost in USD:</label><input type="number" class="form-control result-field" id="totalPreCostUSD" readonly></div>
            <div class="col-md-6"><label>Total Upcharged Pre-cost in Taka:</label><input type="number" class="form-control result-field" id="totalUpchargePreCostTk" readonly></div>
            <div class="col-md-6"><label>Total Upcharged Pre-cost in USD:</label><input type="number" class="form-control result-field" id="totalUpchargePreCostUSD" readonly></div>
        </div>

        <!-- Calculation Results -->
        <div class="section-header">Calculation Results</div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Greige Req Quantity (yds):</label><input type="number" class="form-control result-field" id="greigeReqQuantity" readonly></div>
            <div class="col-md-3"><label>Required Warp Yarn (kg):</label><input type="number" class="form-control result-field" id="requiredWarpKg" readonly></div>
            <div class="col-md-3"><label>Required Weft Yarn (kg):</label><input type="number" class="form-control result-field" id="requiredWeftKg" readonly></div>
            <div class="col-md-3"><label>Total Required Yarn (kg):</label><input type="number" class="form-control result-field" id="totalRequiredKg" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Warp Greige Consump (kg):</label><input type="number" class="form-control result-field" id="warpGreigeConsump" readonly></div>
            <div class="col-md-3"><label>Weft Greige Consump (kg):</label><input type="number" class="form-control result-field" id="weftGreigeConsump" readonly></div>
            <div class="col-md-3"><label>Total Greige Consump (kg):</label><input type="number" class="form-control result-field" id="totalGreigeConsump" readonly></div>
            <div class="col-md-3"><label>Warp Finish Consump (kg):</label><input type="number" class="form-control result-field" id="warpFinishConsump" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Weft Finish Consump (kg):</label><input type="number" class="form-control result-field" id="weftFinishConsump" readonly></div>
            <div class="col-md-3"><label>Total Finish Consump (kg):</label><input type="number" class="form-control result-field" id="totalFinishConsump" readonly></div>
            <div class="col-md-3"><label>Total Greige Yarn Cost/yd:</label><input type="number" class="form-control result-field" id="greigeYarnCostPerYd" readonly></div>
            <div class="col-md-3"><label>Warp Yarn Cost (tk/yd):</label><input type="number" class="form-control result-field" id="warpYnCost" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Weft Yarn Cost (tk/yd):</label><input type="number" class="form-control result-field" id="weftYnCost" readonly></div>
            <div class="col-md-3"><label>Greige Cost (tk/yd):</label><input type="number" class="form-control result-field" id="totalGreigeCost" readonly></div>
            <div class="col-md-3"><label>Yarn Dyeing Cost (tk/yd):</label><input type="number" class="form-control result-field" id="yarnDyeCost" readonly></div>
            <div class="col-md-3"><label>Total Yarn Cost (tk/yd):</label><input type="number" class="form-control result-field" id="totalYnCost" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Weaving Cost (tk/yd):</label><input type="number" class="form-control result-field" id="weavingCost" readonly></div>
            <div class="col-md-3"><label>Break-Even Cost (tk/yd):</label><input type="number" class="form-control result-field" id="breakEvenCostYd" readonly></div>
            <div class="col-md-3"><label>Sales Price (tk/yd):</label><input type="number" class="form-control result-field" id="salesPrice" readonly></div>
            <div class="col-md-3"><label>Upcharged Sales Price (tk/yd):</label><input type="number" class="form-control result-field" id="upchargeSalesPrice" readonly></div>
        </div>

        <!-- Budget Costs -->
        <div class="section-header">Budget Costs</div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Total Warp Cost (tk):</label><input type="number" class="form-control result-field" id="totalGrWarpCost" readonly></div>
            <div class="col-md-3"><label>Warp %:</label><input type="number" class="form-control result-field" id="totalGrWarpCostPercent" readonly></div>
            <div class="col-md-3"><label>Total Weft Cost (tk):</label><input type="number" class="form-control result-field" id="totalGrWeftCost" readonly></div>
            <div class="col-md-3"><label>Weft %:</label><input type="number" class="form-control result-field" id="totalGrWeftCostPercent" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Total Greige Cost (tk):</label><input type="number" class="form-control result-field" id="graTotalGregCost" readonly></div>
            <div class="col-md-3"><label>Greige %:</label><input type="number" class="form-control result-field" id="graTotalGregCostPercent" readonly></div>
            <div class="col-md-3"><label>Total Dyeing Cost (tk):</label><input type="number" class="form-control result-field" id="totalYDyeingCost" readonly></div>
            <div class="col-md-3"><label>Dyeing %:</label><input type="number" class="form-control result-field" id="totalYDyeingCostPercent" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Total Weaving Cost (tk):</label><input type="number" class="form-control result-field" id="totalWeavingCost" readonly></div>
            <div class="col-md-3"><label>Weaving %:</label><input type="number" class="form-control result-field" id="totalWeavingCostPercent" readonly></div>
            <div class="col-md-3"><label>Total Dye/Finish Cost (tk):</label><input type="number" class="form-control result-field" id="totalDyeFinCost" readonly></div>
            <div class="col-md-3"><label>Dye/Finish %:</label><input type="number" class="form-control result-field" id="totalDyeFinCostPercent" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Total Commercial Cost (tk):</label><input type="number" class="form-control result-field" id="totalCommercialCost" readonly></div>
            <div class="col-md-3"><label>Commercial %:</label><input type="number" class="form-control result-field" id="commercialCostPercent" readonly></div>
            <div class="col-md-3"><label>Grand Total Break-Even Cost (tk):</label><input type="number" class="form-control result-field" id="grandTotalBECost" readonly></div>
            <div class="col-md-3"><label>Net Break-Even Cost/yd (tk):</label><input type="number" class="form-control result-field" id="netBreakEvenCostPerYd" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Net Profit/yd (tk):</label><input type="number" class="form-control result-field" id="netProfitPerYd" readonly></div>
            <div class="col-md-3"><label>Grand Total Profit (tk):</label><input type="number" class="form-control result-field" id="grandTotalProfit" readonly></div>
            <div class="col-md-3"><label>Grand Total Profit %:</label><input type="number" class="form-control result-field" id="grandTotalProfitPercent" readonly></div>
            <div class="col-md-3"><label>Total Sales Value (tk):</label><input type="number" class="form-control result-field" id="totalSalesValue" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Upcharged Net Profit/yd (tk):</label><input type="number" class="form-control result-field" id="upchargeNetProfit" readonly></div>
            <div class="col-md-3"><label>Upcharged Grand Total Profit (tk):</label><input type="number" class="form-control result-field" id="upchargeGrandTotalProfit" readonly></div>
            <div class="col-md-3"><label>Upcharged Grand Total Profit %:</label><input type="number" class="form-control result-field" id="upGrandTotalProfitPercent" readonly></div>
            <div class="col-md-3"><label>Upcharged Total Sales Value (tk):</label><input type="number" class="form-control result-field" id="upchargeTotalSalesValue" readonly></div>
        </div>

        <!-- Technical Specifications -->
        <div class="section-header">Technical Specifications</div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Warp GSM:</label><input type="number" class="form-control result-field" id="warpTotalGSM" readonly></div>
            <div class="col-md-3"><label>Weft GSM:</label><input type="number" class="form-control result-field" id="weftTotalGSM" readonly></div>
            <div class="col-md-3"><label>Total GSM:</label><input type="number" class="form-control result-field" id="totalGSM" readonly></div>
            <div class="col-md-3"><label>Weight of Finish Fabric (kg):</label><input type="number" class="form-control result-field" id="weightFinishFabric" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><label>Warp Cover Factor:</label><input type="number" class="form-control result-field" id="warpCoverFactor" readonly></div>
            <div class="col-md-3"><label>Weft Cover Factor:</label><input type="number" class="form-control result-field" id="weftCoverFactor" readonly></div>
            <div class="col-md-3"><label>Total Cover Factor:</label><input type="number" class="form-control result-field" id="totalCoverFactor" readonly></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
// let’s use a global variable called currentPreCostingData to store the fetched Supabase data	
// Initialize currentPreCostingData with default values
let currentPreCostingData = {
    preCostingData: null,
    warpDetails: [],
    weftDetails: []
};	
// Import Supabase client
const { createClient } = window.supabase;
const supabaseUrl = 'https://qebqccpbnmgvtbzawluk.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlYnFjY3Bibm1ndnRiemF3bHVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxMDIzMTcsImV4cCI6MjA1NzY3ODMxN30.tdoAzpyJe7X76dQsLaDYWoy2VrpxXBc7RXmyqxROaQI';
const supabase = createClient(supabaseUrl, supabaseKey);

// Hardcoded password hash for "pass123" (MD5 hash)
const hashedPassword = '32250170a0dca92d53ec9624f336ca24';

// Login functionality
let isLoggedIn = false;

// Function to generate the next pre-costing number
async function generateNextPreCostingNo() {
    try {
        const { data, error } = await supabase
            .from('pre_costing_data')
            .select('pre_costing_no')
            .order('pre_costing_no', { ascending: false })
            .limit(1);

        if (error) throw error;

        let nextNumber = 1;
        if (data && data.length > 0) {
            const lastPreCostingNo = data[0].pre_costing_no; // e.g., "Pre/costing/No:01" or "Pre/costing/No:100"
            const match = lastPreCostingNo.match(/Pre\/costing\/No:(\d+)/);
            if (match) {
                const lastNumber = parseInt(match[1], 10);
                nextNumber = lastNumber + 1;
            }
        }

        if (nextNumber > 10000000) {
            throw new Error('Maximum pre-costing number (10,000,000) reached.');
        }

        // Format the number: "Pre/costing/No:XX" (01-09 for 1-9, 10-10000000 as is)
        const formattedNumber = nextNumber < 10 ? `0${nextNumber}` : nextNumber;
        return `Pre/costing/No:${formattedNumber}`;
    } catch (error) {
        console.error('Error generating pre-costing number:', error);
        return 'Pre/costing/No:01'; // Fallback to 01 if there's an error
    }
}

// Set the initial pre-costing number on page load
async function setInitialPreCostingNo() {
    const preCostingNoInput = document.getElementById('preCostingNo');
    const nextPreCostingNo = await generateNextPreCostingNo();
    preCostingNoInput.value = nextPreCostingNo;
}



// Function to set up all event listeners after login
function setupEventListeners() {
    // Populate dropdown on page load
    populatePreCostingDropdown();

    // Set initial pre-costing number
    setInitialPreCostingNo();
	
	calculateForm();

    // Search button
    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) {
        searchBtn.addEventListener('click', searchPreCosting);
    } else {
        console.error('searchBtn element not found');
    }

    // Save to PostgreSQL button
    const saveToPostgreSQLBtn = document.getElementById('saveToPostgreSQLBtn');
    if (saveToPostgreSQLBtn) {
        saveToPostgreSQLBtn.addEventListener('click', saveToPostgreSQL);
    } else {
        console.error('saveToPostgreSQLBtn element not found');
    }

    // Export to CSV button
    const exportToCSVBtn = document.getElementById('exportToCSVBtn');
    if (exportToCSVBtn) {
        exportToCSVBtn.addEventListener('click', exportToCSV);
    } else {
        console.error('exportToCSVBtn element not found');
    }

    // Export to SQL button
    const exportToSQLBtn = document.getElementById('exportToSQLBtn');
    if (exportToSQLBtn) {
        exportToSQLBtn.addEventListener('click', exportToSQL);
    } else {
        console.error('exportToSQLBtn element not found');
    }

    // Save button (local save)
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveLocally);
    } else {
        console.error('saveBtn element not found');
    }

    // Load button
    const loadBtn = document.getElementById('loadBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', showLoadModal);
    } else {
        console.error('loadBtn element not found');
    }
	
	// Validate and format preCostingNo input
    const preCostingNoInput = document.getElementById('preCostingNo');
    preCostingNoInput.addEventListener('input', (e) => {
        let value = e.target.value;
        // Check if the input is already in the format "Pre/costing/No:XX"
        const match = value.match(/Pre\/costing\/No:(\d+)/);
        if (match) {
            // If already formatted, extract the number and allow it to remain
            value = match[1];
        } else {
            // Otherwise, treat as a raw number
            value = value.replace(/\D/g, ''); // Remove non-digits
            if (value === '') {
                e.target.value = 'Pre/costing/No:01';
                return;
            }
        }
        value = parseInt(value, 10);
        if (value < 1) value = 1;
        if (value > 10000000) value = 10000000;
        const formattedNumber = value < 10 ? `0${value}` : value;
        e.target.value = `Pre/costing/No:${formattedNumber}`;
    });


    // Clear button
    const clearBtn = document.getElementById('clearBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
            if (!isLoggedIn) {
                alert('Please log in to perform this action.');
                return;
            }
            // Clear input fields
            document.querySelectorAll('input:not([type="button"]):not([type="submit"])').forEach(input => {
                if (!input.readOnly) input.value = '';
            });

            // Clear result fields
            document.querySelectorAll('.result-field').forEach(field => {
                field.value = '0.00';
            });

            // Clear result cells in Warp and Weft tables
            document.querySelectorAll('#warpCalculationTable .result-cell, #weftCalculationTable .result-cell').forEach(cell => {
                cell.textContent = '0.00';
            });

            // Reset Warp and Weft tables
            const warpTbody = document.getElementById('warpCalculationTable').querySelector('tbody');
            const weftTbody = document.getElementById('weftCalculationTable').querySelector('tbody');
            warpTbody.innerHTML = '';
            weftTbody.innerHTML = '';

            // Add one empty row to each table
            addEmptyWarpRow(warpTbody);
            addEmptyWeftRow(weftTbody);

            // Reset pre-costing number
            await setInitialPreCostingNo();

            calculateForm();
        });
    } else {
        console.error('clearBtn element not found');
    }

    // Reset button
    const resetBtn = document.getElementById('resetBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', async () => {
            if (!isLoggedIn) {
                alert('Please log in to perform this action.');
                return;
            }
            document.querySelectorAll('input:not([type="button"]):not([type="submit"])').forEach(input => {
                if (!input.readOnly) input.value = input.defaultValue || '';
            });

            // Reset pre-costing number
            await setInitialPreCostingNo();

            calculateForm();
        });
    } else {
        console.error('resetBtn element not found');
    }

    // Add warp row
    const addWarpRowBtn = document.querySelector('.add-warp-row');
if (addWarpRowBtn) {
    addWarpRowBtn.addEventListener('click', () => {
        if (!isLoggedIn) {
            alert('Please log in to perform this action.');
            return;
        }
        const tbody = document.getElementById('warpCalculationTable').querySelector('tbody');
        addEmptyWarpRow(tbody);
    });
} else {
    console.error('add-warp-row element not found');
}

    // Add weft row
    const addWeftRowBtn = document.querySelector('.add-weft-row');
if (addWeftRowBtn) {
    addWeftRowBtn.addEventListener('click', () => {
        if (!isLoggedIn) {
            alert('Please log in to perform this action.');
            return;
        }
        const tbody = document.getElementById('weftCalculationTable').querySelector('tbody');
        addEmptyWeftRow(tbody);
    });
} else {
    console.error('add-weft-row element not found');
}

    // Event delegation for input changes in Warp and Weft tables
    document.addEventListener('input', (e) => {
        if (!isLoggedIn) return;
        const target = e.target;
        if (target.closest('#warpCalculationTable') || target.closest('#weftCalculationTable')) {
            console.log('Input changed in table:', target.value, 'in element:', target);
            calculateForm();
        }
    });

    // Event delegation for other inputs and selects outside the tables
    document.querySelectorAll('input:not(#warpCalculationTable input):not(#weftCalculationTable input), select:not(#warpCalculationTable select):not(#weftCalculationTable select)').forEach(input => {
        input.addEventListener('input', () => {
            if (!isLoggedIn) return;
            console.log('Input changed outside table:', input.id, input.value);
            calculateForm();
        });
    });

    // Remove row event delegation
    document.addEventListener('click', (e) => {
        if (!isLoggedIn) return;
        if (e.target.closest('.remove-row')) {
            const row = e.target.closest('tr');
            if (row.parentNode.children.length > 1) {
                row.remove();
                console.log('Row removed from table');
                calculateForm();
            }
        }
    });
}

// Login button event listener
document.getElementById('loginBtn').addEventListener('click', () => {
    const passwordInput = document.getElementById('passwordInput');
    const password = passwordInput.value;
    console.log('Login attempt with raw password:', password);
    console.log('Password length:', password.length);
    console.log('Password characters:', password.split('').map(char => char.charCodeAt(0)));

    const hashedInput = md5(password);
    console.log('Hashed input password:', hashedInput);
    console.log('Expected hash:', hashedPassword);

    if (hashedInput === hashedPassword) {
        isLoggedIn = true;
        console.log('Login successful! isLoggedIn:', isLoggedIn);
        //alert('Login successful!');
        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
        loginModal.hide();

        // Set up event listeners after login
        setupEventListeners();

        // Initial calculation
        calculateForm();
    } else {
        console.log('Login failed: Incorrect password');
        alert('Incorrect password! Please try again. Use "pass123".');
        passwordInput.value = ''; // Clear the input
    }
});

// Show login modal on page load
document.addEventListener('DOMContentLoaded', () => {
    if (!isLoggedIn) {
        console.log('User not logged in, showing login modal');
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
    } else {
        console.log('User already logged in, setting up event listeners');
        setupEventListeners();
        calculateForm();
    }
});

// Pre-costing calculator
console.log("PreCosting calculator loaded");

const PreCostingCalculator = {
    constants: {
        LBS_TO_KG: 0.453592,
        YARDS_TO_METERS: 0.9144,
        KG_TO_LBS: 2.2046,
        METERS_TO_YARDS: 1.09361,
        weaveConstants: {
            'Plain': 1,
            'Oxford': 0.94,
            'Ottoman': 0.95,
            'Matt': 0.77,
            '2/1 Twill': 0.85,
            '2/2 Twill': 0.8,
            '3/1 Twill': 0.75,
            '4/1 Satin': 0.715,
            '3/2 Twill': 0.7,
            '3/3 Twill': 0.65,
            '3/3 Matt': 0.64,
            '3/2 Matt': 0.66,
            '4/4 Twill': 0.6,
            '4/2 Twill': 0.63,
            '6/2 Twill': 0.55,
            '2/2 Oxford Twill': 0.74,
            '3/1 Oxford Twill': 0.68,
            '2/1 Matt Twill': 0.74,
            '2/2 Matt Twill': 0.68,
            '3/1 Matt Twill': 0.66,
            '3/3 Matt Twill': 0.58,
            '4/4 Matt Twill': 0.54,
            'Dobby': 0.8
        }
    },

    calculateWarpRepeatEnds(construction) {
        return parseInt(construction?.split('/')[1]?.split('x')[0]) || 0;
    },
    calculateWarpDentNumbers(patternTotalEnds, denting) {
        return denting ? (patternTotalEnds / denting) : 0;
    },
    calculateAdjustedWarpYarn(requiredYarn, warpWastage) {
        return requiredYarn * (1 + (warpWastage / 100));
    },
    calculateAdjustedWeftYarn(requiredYarn, weftWastage) {
        return requiredYarn * (1 + (weftWastage / 100));
    },
    calculateYarnDyeingAdjustment(yarnCost, ydAllowPercentage) {
        return yarnCost * (1 + (ydAllowPercentage / 100));
    },
    calculateGreigeCostPerYd(warpYarnCostPreDyeing, weftYarnCostPreDyeing, wastageOverheadFactor = 0) {
        return (warpYarnCostPreDyeing + weftYarnCostPreDyeing + wastageOverheadFactor) || 0;
    },
    calculateWarpConsumption(count, patternTotalEnds, warpCrimp, ydAllow, warpWast, finishAllow) {
        return (count && patternTotalEnds) ?
            (patternTotalEnds * (1 + (warpCrimp / 100)) * (1 + (ydAllow / 100)) * (1 + (warpWast / 100)) * (1 + (finishAllow / 100))) /
            (count * 1693.3 * this.constants.METERS_TO_YARDS) : 0;
    },
    calculateWeftConsumption(count, patternTotalPicks, pickLength, finishAllow, ydAllow, weftWast) {
        return count ?
            (patternTotalPicks * pickLength *
            (1 + (finishAllow / 100)) *
            (1 + (ydAllow / 100)) *
            (1 + (weftWast / 100))) /
            (count * 1693.3 * this.constants.METERS_TO_YARDS * 39.37) : 0;
    },
    calculateYarnCostPerYd(consumption, greigeYarnRate) {
        return consumption * greigeYarnRate || 0;
    },
    calculateYarnDyeingCostPerYd(consumption, dyeingCostPerKg) {
        return consumption * dyeingCostPerKg || 0;
    },
    calculateTotalYarnCostPerYd(yarnCost, dyeingCost) {
        return (yarnCost + dyeingCost) || 0;
    },
    calculateRequiredYarn(consumption, orderQuantity) {
        return consumption * orderQuantity || 0;
    },
    calcGreigeRequiredQty(orderQuantity, finishAllow) {
        return orderQuantity * (1 + (finishAllow / 100)) || 0;
    },
    calculateBreakEvenCostPerYd(yarnCost, weavingCost, dyeingFinishingCost, commercialCost) {
        return (yarnCost + weavingCost + dyeingFinishingCost + commercialCost) || 0;
    },
    calculateSalesPricePerYd(breakEvenCost, profitPerYd) {
        return (breakEvenCost + profitPerYd) || 0;
    },
    calculateTotalValue(valuePerYd, quantity) {
        return valuePerYd * quantity || 0;
    },
    calculatePercentage(part, whole) {
        return whole ? ((part / whole) * 100) : 0;
    },
    calculateCoverFactor(epi, count) {
        return epi / Math.sqrt(count || 1);
    },

    calculateWarpPattern(warpDetails, formData, warpRepeatEnds, warpRepeatNumber) {
        const totalRepeatBreakdown = warpDetails.reduce((sum, detail) => sum + (detail.repeatBreakdown || 0), 0) || 1;
        const totalRepeatBreakdownDenting = warpDetails.reduce((sum, detail) => sum + ((detail.repeatBreakdown || 0) * (detail.denting || 0)), 0) || 1;
        const results = [];
        let totalEnds = 0, totalConsumption = 0, totalYarnCost = 0, totalColorCost = 0, totalWarpCost = 0, totalRequiredGreige = 0, totalGreigeYarnCostPreDyeing = 0;

        for (const detail of warpDetails) {
            const count = detail.count || 0;
            const repeatBreakdown = detail.repeatBreakdown || 0;
            const denting = detail.denting || 0;
            const ratePerLbs = detail.ratePerLbs || 0;
            const dyeingCostPerKg = detail.dyeingCostPerKg || 0;
            const greigeYarnRate = ratePerLbs * this.constants.KG_TO_LBS;

            const repeatEndsPerColor = totalRepeatBreakdownDenting ?
                ((repeatBreakdown * denting) / totalRepeatBreakdownDenting) * warpRepeatEnds : 0;
            const patternTotalEnds = repeatEndsPerColor * warpRepeatNumber;

            const consumption = this.calculateWarpConsumption(
                count, patternTotalEnds, formData.warpCrimp, formData.ydAllow, formData.warpWast, formData.finishAllow
            );
            const yarnCost = this.calculateYarnCostPerYd(consumption, greigeYarnRate);
            const colorCost = this.calculateYarnDyeingCostPerYd(consumption, dyeingCostPerKg);
            const warpTotalCost = this.calculateTotalYarnCostPerYd(yarnCost, colorCost);
            const requiredGreige = this.calculateRequiredYarn(consumption, formData.orderQuantity);
            const dentNumbersInFullWidth = this.calculateWarpDentNumbers(patternTotalEnds, denting);

            totalEnds += patternTotalEnds;
            totalConsumption += consumption;
            totalYarnCost += yarnCost;
            totalColorCost += colorCost;
            totalWarpCost += warpTotalCost;
            totalRequiredGreige += requiredGreige;
            totalGreigeYarnCostPreDyeing += yarnCost;

            results.push({
                repeatEndsPerColor, patternTotalEnds, dentNumbersInFullWidth, greigeYarnRate,
                consumption, yarnCost, colorCost, warpTotalCost, requiredGreige
            });
        }
        return {
            patterns: results,
            totals: { totalEnds, totalConsumption, totalYarnCost, totalColorCost, totalWarpCost, totalRequiredGreige, totalGreigeYarnCostPreDyeing }
        };
    },

    calculateWeftPattern(weftDetails, formData, weftRepeatNumber) {
        const totalRepeatBreakdown = weftDetails.reduce((sum, detail) => sum + (detail.repeatBreakdown || 0), 0) || 1;
        const results = [];
        let totalPicks = 0, totalConsumption = 0, totalYarnCost = 0, totalColorCost = 0, totalWeftCost = 0, totalRequiredGreige = 0, totalGreigeYarnCostPreDyeing = 0;

        for (const detail of weftDetails) {
            const count = detail.count || 0;
            const repeatBreakdown = detail.repeatBreakdown || 0;
            const pickDensity = detail.pickDensity || 0;
            const ratePerLbs = detail.ratePerLbs || 0;
            const dyeingCostPerKg = detail.dyeingCostPerKg || 0;
            const greigeYarnRate = ratePerLbs * this.constants.KG_TO_LBS;
            const repeatPicksPerColor = repeatBreakdown * pickDensity;
            const patternTotalPicks = repeatPicksPerColor * weftRepeatNumber;

            const consumption = this.calculateWeftConsumption(
                count,
                patternTotalPicks,
                formData.pickLength,
                formData.finishAllow,
                formData.ydAllow,
                formData.weftWast
            );

            const yarnCost = this.calculateYarnCostPerYd(consumption, greigeYarnRate);
            const colorCost = this.calculateYarnDyeingCostPerYd(consumption, dyeingCostPerKg);
            const weftTotalCost = this.calculateTotalYarnCostPerYd(yarnCost, colorCost);
            const requiredGreige = this.calculateRequiredYarn(consumption, formData.orderQuantity);

            totalPicks += patternTotalPicks;
            totalConsumption += consumption;
            totalYarnCost += yarnCost;
            totalColorCost += colorCost;
            totalWeftCost += weftTotalCost;
            totalRequiredGreige += requiredGreige;
            totalGreigeYarnCostPreDyeing += yarnCost;

            results.push({
                repeatPicksPerColor, patternTotalPicks, greigeYarnRate,
                consumption, yarnCost, colorCost, weftTotalCost, requiredGreige
            });
        }
        return {
            patterns: results,
            totals: { totalPicks, totalConsumption, totalYarnCost, totalColorCost, totalWeftCost, totalRequiredGreige, totalGreigeYarnCostPreDyeing }
        };
    },

    calculateFullPreCosting(formData) {
        const warpRepeatSize = formData.warpDetails.reduce((sum, d) => sum + (d.repeatBreakdown || 0), 0) || 1;
        const warpRepeatNumber = warpRepeatSize ? Math.round(formData.finishWidth / warpRepeatSize) : 1;
        const warpRepeatEnds = formData.totalEnds / warpRepeatNumber || 0;

        const weftRepeatSize = formData.weftDetails.reduce((sum, d) => sum + (d.repeatBreakdown || 0), 0) || 1;
        const weftRepeatNumber = weftRepeatSize ? parseFloat((39.37 / weftRepeatSize).toFixed(2)) : 1;

        const warpResults = this.calculateWarpPattern(formData.warpDetails || [], formData, warpRepeatEnds, warpRepeatNumber);
        const weftResults = this.calculateWeftPattern(formData.weftDetails || [], formData, weftRepeatNumber);

        const totalRepeatBreakdownWarp = formData.warpDetails.reduce((sum, detail) => sum + (detail.repeatBreakdown || 0), 0) || 1;
        const totalRepeatBreakdownWeft = formData.weftDetails.reduce((sum, detail) => sum + (detail.repeatBreakdown || 0), 0) || 1;

        const greigeReqQuantity = this.calcGreigeRequiredQty(formData.orderQuantity, formData.finishAllow);
        const requiredWarpKg = warpResults.totals.totalRequiredGreige;
        const requiredWeftKg = weftResults.totals.totalRequiredGreige;
        const totalRequiredKg = requiredWarpKg + requiredWeftKg;
        const warpGreigeConsump = greigeReqQuantity ? requiredWarpKg / greigeReqQuantity : 0;
        const weftGreigeConsump = greigeReqQuantity ? requiredWeftKg / greigeReqQuantity : 0;
        const totalGreigeConsump = warpGreigeConsump + weftGreigeConsump;
        const warpFinishConsump = formData.orderQuantity ? requiredWarpKg / formData.orderQuantity : 0;
        const weftFinishConsump = formData.orderQuantity ? requiredWeftKg / formData.orderQuantity : 0;
        const totalFinishConsump = warpFinishConsump + weftFinishConsump;
        const weavingCost = formData.weavingPickRate * (weftResults.totals.totalPicks / weftRepeatNumber) * (1 + (formData.finishAllow / 100));

        const warpYnCost = warpResults.totals.totalYarnCost;
        const weftYnCost = weftResults.totals.totalYarnCost;
        const totalGreigeCost = this.calculateGreigeCostPerYd(warpYnCost, weftYnCost);
        const yarnDyeCost = warpResults.totals.totalColorCost + weftResults.totals.totalColorCost;
        const totalYnCost = this.calculateTotalYarnCostPerYd(totalGreigeCost, yarnDyeCost);
        const breakEvenCostYd = this.calculateBreakEvenCostPerYd(
            totalYnCost,
            weavingCost,
            formData.dyeingFinishingRate,
            formData.commercialCostInput
        );
        const greigeYarnCostPerYd = breakEvenCostYd ? (breakEvenCostYd - formData.dyeingFinishingRate - weavingCost) / (1 + (formData.finishAllow / 100)) : 0;

        const salesPrice = this.calculateSalesPricePerYd(breakEvenCostYd, formData.profit);
        const upchargeSalesPrice =
            formData.orderQuantity >= 100 && formData.orderQuantity <= 999 ? salesPrice * 1.5 :
            formData.orderQuantity >= 1000 && formData.orderQuantity <= 2000 ? salesPrice * 1.35 :
            formData.orderQuantity >= 2001 && formData.orderQuantity <= 3000 ? salesPrice * 1.2 : salesPrice;

        const totalGrWarpCost = formData.orderQuantity * warpYnCost;
        const totalGrWarpCostPercent = this.calculatePercentage(totalGrWarpCost, breakEvenCostYd * formData.orderQuantity);
        const totalGrWeftCost = formData.orderQuantity * weftYnCost;
        const totalGrWeftCostPercent = this.calculatePercentage(totalGrWeftCost, breakEvenCostYd * formData.orderQuantity);
        const graTotalGregCost = totalGrWarpCost + totalGrWeftCost;
        const graTotalGregCostPercent = this.calculatePercentage(graTotalGregCost, breakEvenCostYd * formData.orderQuantity);
        const totalYDyeingCost = formData.orderQuantity * yarnDyeCost;
        const totalYDyeingCostPercent = this.calculatePercentage(totalYDyeingCost, breakEvenCostYd * formData.orderQuantity);
        const totalWeavingCost = formData.orderQuantity * weavingCost;
        const totalWeavingCostPercent = this.calculatePercentage(totalWeavingCost, breakEvenCostYd * formData.orderQuantity);
        const totalDyeFinCost = formData.orderQuantity * formData.dyeingFinishingRate;
        const totalDyeFinCostPercent = this.calculatePercentage(totalDyeFinCost, breakEvenCostYd * formData.orderQuantity);
        const totalCommercialCost = formData.orderQuantity * formData.commercialCostInput;
        const commercialCostPercent = this.calculatePercentage(totalCommercialCost, breakEvenCostYd * formData.orderQuantity);
        const grandTotalBECost = graTotalGregCost + totalYDyeingCost + totalWeavingCost + totalDyeFinCost + totalCommercialCost;
        const netBreakEvenCostPerYd = formData.orderQuantity ? grandTotalBECost / formData.orderQuantity : 0;
        const netProfitPerYd = salesPrice - netBreakEvenCostPerYd;
        const grandTotalProfit = formData.orderQuantity * netProfitPerYd;
        const grandTotalProfitPercent = this.calculatePercentage(grandTotalProfit, grandTotalBECost);
        const totalSalesValue = this.calculateTotalValue(salesPrice, formData.orderQuantity);
        const upchargeNetProfit = upchargeSalesPrice - netBreakEvenCostPerYd;
        const upchargeGrandTotalProfit = formData.orderQuantity * upchargeNetProfit;
        const upGrandTotalProfitPercent = this.calculatePercentage(upchargeGrandTotalProfit, grandTotalBECost);
        const upchargeTotalSalesValue = this.calculateTotalValue(upchargeSalesPrice, formData.orderQuantity);

        const totalPreCostTk = salesPrice;
        const totalPreCostUSD = formData.dollarRateTk ? totalPreCostTk / formData.dollarRateTk : 0;
        const totalUpchargePreCostTk = upchargeSalesPrice;
        const totalUpchargePreCostUSD = formData.dollarRateTk ? totalUpchargePreCostTk / formData.dollarRateTk : 0;

        const warpTotalGSM = warpFinishConsump * 1000 / (formData.finishWidth * 0.0254);
        const weftTotalGSM = weftFinishConsump * 1000 / (formData.finishWidth * 0.0254);
        const totalGSM = warpTotalGSM + weftTotalGSM;
        const weightFinishFabric = totalFinishConsump * formData.orderQuantity;

        const avgWarpCount = formData.warpDetails.reduce((sum, d) => sum + (d.count || 0), 0) / (formData.warpDetails.length || 1);
        const avgWeftCount = formData.weftDetails.reduce((sum, d) => sum + (d.count || 0), 0) / (formData.weftDetails.length || 1);
        const warpCoverFactor = this.calculateCoverFactor(formData.epi, avgWarpCount);
        const weftCoverFactor = this.calculateCoverFactor(formData.ppi, avgWeftCount);
        const totalCoverFactor = warpCoverFactor + weftCoverFactor - (warpCoverFactor * weftCoverFactor / (warpCoverFactor + weftCoverFactor));

        return {
            inputSummary: {
                preCostingNo: formData.preCostingNo,
                buyer: formData.buyer,
                construction: formData.construction,
                finishWidth: formData.finishWidth,
                totalEnds: formData.totalEnds,
                warpCrimp: formData.warpCrimp,
                ydAllow: formData.ydAllow,
                warpWast: formData.warpWast,
                weftWast: formData.weftWast,
                finishAllow: formData.finishAllow,
                weavingPickRate: formData.weavingPickRate,
                dyeingFinishingRate: formData.dyeingFinishingRate,
                commercialCostInput: formData.commercialCostInput,
                profit: formData.profit,
                orderQuantity: formData.orderQuantity,
                pickLength: formData.pickLength,
                preCostingDate: formData.preCostingDate,
                dollarRateTk: formData.dollarRateTk,
                epi: formData.epi,
                ppi: formData.ppi,
                weaveType: formData.weaveType,
                weftCrimp: formData.weftCrimp,
                greigeWidth: formData.greigeWidth
            },
            orderParticulars: {
                greigeReqQuantity, requiredWarpKg, requiredWeftKg, totalRequiredKg,
                warpGreigeConsump, weftGreigeConsump, totalGreigeConsump,
                warpFinishConsump, weftFinishConsump, totalFinishConsump,
                greigeYarnCostPerYd
            },
            costBreakdown: {
                warpYnCost, weftYnCost, totalGreigeCost, yarnDyeCost, totalYnCost,
                weavingCost, breakEvenCostYd, salesPrice, upchargeSalesPrice
            },
            budgetCost: {
                totalGrWarpCost, totalGrWarpCostPercent,
                totalGrWeftCost, totalGrWeftCostPercent,
                graTotalGregCost, graTotalGregCostPercent,
                totalYDyeingCost, totalYDyeingCostPercent,
                totalWeavingCost, totalWeavingCostPercent,
                totalDyeFinCost, totalDyeFinCostPercent,
                totalCommercialCost, commercialCostPercent,
                grandTotalBECost, netBreakEvenCostPerYd,
                netProfitPerYd, grandTotalProfit, grandTotalProfitPercent, totalSalesValue,
                upchargeNetProfit, upchargeGrandTotalProfit, upGrandTotalProfitPercent, upchargeTotalSalesValue
            },
            technicalSpecs: {
                warpTotalGSM, weftTotalGSM, totalGSM, weightFinishFabric,
                warpCoverFactor, weftCoverFactor, totalCoverFactor
            },
            warpPatterns: { patterns: warpResults.patterns, totals: warpResults.totals },
            weftPatterns: { patterns: weftResults.patterns, totals: weftResults.totals },
            patternSummary: {
                warpRepeatSize, warpRepeatNumber, warpRepeatEnds, weftRepeatSize, weftRepeatNumber
            },
            totalPreCostingValues: { totalPreCostTk, totalPreCostUSD, totalUpchargePreCostTk, totalUpchargePreCostUSD }
        };
    }
};

function getFormData() {
    const warpTbody = document.getElementById('warpCalculationTable').querySelector('tbody');
    const weftTbody = document.getElementById('weftCalculationTable').querySelector('tbody');

    const warpDetails = Array.from(warpTbody.querySelectorAll('tr:not(.total-row)')).map(row => ({
        count: parseFloat(row.cells[0].querySelector('input').value) || 0,
        repeatBreakdown: parseFloat(row.cells[1].querySelector('input').value) || 0,
        colorName: row.cells[2].querySelector('input').value || '',
        denting: parseFloat(row.cells[3].querySelector('input').value) || 0,
        ratePerLbs: parseFloat(row.cells[4].querySelector('input').value) || 0,
        dyeingCostPerKg: parseFloat(row.cells[5].querySelector('input').value) || 0
    }));

    const weftDetails = Array.from(weftTbody.querySelectorAll('tr:not(.total-row)')).map(row => ({
        count: parseFloat(row.cells[0].querySelector('input').value) || 0,
        repeatBreakdown: parseFloat(row.cells[1].querySelector('input').value) || 0,
        colorName: row.cells[2].querySelector('input').value || '',
        pickDensity: parseFloat(row.cells[3].querySelector('input').value) || 0,
        ratePerLbs: parseFloat(row.cells[4].querySelector('input').value) || 0,
        dyeingCostPerKg: parseFloat(row.cells[5].querySelector('input').value) || 0
    }));

    // Extract preCostingNo and handle both formatted and unformatted inputs
    let preCostingNo = document.getElementById('preCostingNo').value || '1';
    // Check if the input is already in the format "Pre/costing/No:XX"
    const match = preCostingNo.match(/Pre\/costing\/No:(\d+)/);
    if (match) {
        // If already formatted, extract the number
        preCostingNo = match[1]; // e.g., "03"
    }
    // Parse the number and reformat
    const number = parseInt(preCostingNo, 10) || 1; // Fallback to 1 if parsing fails
    const formattedNumber = number < 10 ? `0${number}` : number;
    preCostingNo = `Pre/costing/No:${formattedNumber}`;

    return {
        preCostingNo: preCostingNo,
        buyer: document.getElementById('buyer').value || '',
        construction: document.getElementById('construction').value || '',
        finishWidth: parseFloat(document.getElementById('finishWidth').value) || 0,
        totalEnds: parseFloat(document.getElementById('totalEnds').value) || 0,
        warpCrimp: parseFloat(document.getElementById('warpCrimp').value) || 0,
        ydAllow: parseFloat(document.getElementById('ydAllow').value) || 0,
        warpWast: parseFloat(document.getElementById('warpWast').value) || 0,
        weftWast: parseFloat(document.getElementById('weftWast').value) || 0,
        finishAllow: parseFloat(document.getElementById('finishAllow').value) || 0,
        weavingPickRate: parseFloat(document.getElementById('weavingPickRate').value) || 0,
        dyeingFinishingRate: parseFloat(document.getElementById('dyeingFinishingRate').value) || 0,
        commercialCostInput: parseFloat(document.getElementById('commercialCostInput').value) || 0,
        profit: parseFloat(document.getElementById('profit').value) || 0,
        orderQuantity: parseFloat(document.getElementById('orderQuantity').value) || 0,
        pickLength: parseFloat(document.getElementById('pickLength').value) || 0,
        preCostingDate: document.getElementById('preCostingDate').value || '',
        dollarRateTk: parseFloat(document.getElementById('dollarRateTk').value) || 0,
        epi: parseFloat(document.getElementById('epi').value) || 0,
        ppi: parseFloat(document.getElementById('ppi').value) || 0,
        weaveType: document.getElementById('weaveType').value || '',
        weftCrimp: parseFloat(document.getElementById('weftCrimp').value) || 0,
        greigeWidth: parseFloat(document.getElementById('greigeWidth').value) || 0,
        warpDetails: warpDetails,
        weftDetails: weftDetails
    };
}

function updateWarpCalculationTable(results, formData) {
    const tbody = document.getElementById('warpCalculationTable').querySelector('tbody');
    if (!tbody) return;

    // Remove existing total row
    const existingTotalRow = tbody.querySelector('.total-row');
    if (existingTotalRow) existingTotalRow.remove();

    const warpPatterns = results.warpPatterns.patterns || [];
    const warpDetails = formData.warpDetails || [];

    // Update existing rows with pattern data
    Array.from(tbody.querySelectorAll('tr:not(.total-row)')).forEach((row, index) => {
        const pattern = warpPatterns[index];
        if (pattern) {
            row.cells[6].textContent = pattern.repeatEndsPerColor.toFixed(2) || '0.00';
            row.cells[7].textContent = pattern.patternTotalEnds.toFixed(2) || '0.00';
            row.cells[8].textContent = pattern.dentNumbersInFullWidth.toFixed(2) || '0.00';
            row.cells[9].textContent = pattern.greigeYarnRate.toFixed(1) || '0.0';
            row.cells[10].textContent = pattern.consumption.toFixed(4) || '0.0000';
            row.cells[11].textContent = pattern.yarnCost.toFixed(2) || '0.00';
            row.cells[12].textContent = pattern.colorCost.toFixed(2) || '0.00';
            row.cells[13].textContent = pattern.warpTotalCost.toFixed(2) || '0.00';
            row.cells[14].textContent = pattern.requiredGreige.toFixed(2) || '0.00';
            row.cells[15].innerHTML = '<button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button>';
        }
    });

    // Add total row
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
        <td>${(warpDetails.reduce((sum, d) => sum + (d.count || 0), 0) / warpDetails.length || 0).toFixed(2)}</td>
        <td>${(warpDetails.reduce((sum, d) => sum + (d.repeatBreakdown || 0), 0) || 0).toFixed(2)}</td>
        <td>-</td>
        <td>${(warpDetails.reduce((sum, d) => sum + (d.denting || 0), 0) / warpDetails.length || 0).toFixed(2)}</td>
        <td>${(warpDetails.reduce((sum, d) => sum + (d.ratePerLbs || 0), 0) / warpDetails.length || 0).toFixed(2)}</td>
        <td>${(warpDetails.reduce((sum, d) => sum + (d.dyeingCostPerKg || 0), 0) / warpDetails.length || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.repeatEndsPerColor || 0), 0) || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.patternTotalEnds || 0), 0) || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.dentNumbersInFullWidth || 0), 0) || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.greigeYarnRate || 0), 0) / warpPatterns.length || 0).toFixed(1)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.consumption || 0), 0) || 0).toFixed(4)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.yarnCost || 0), 0) || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.colorCost || 0), 0) || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.warpTotalCost || 0), 0) || 0).toFixed(2)}</td>
        <td>${(warpPatterns.reduce((sum, p) => sum + (p.requiredGreige || 0), 0) || 0).toFixed(2)}</td>
        <td>-</td>
    `;
    tbody.appendChild(totalRow);
}

function updateWeftCalculationTable(results, formData) {
    const tbody = document.getElementById('weftCalculationTable').querySelector('tbody');
    if (!tbody) return;

    // Remove existing total row
    const existingTotalRow = tbody.querySelector('.total-row');
    if (existingTotalRow) existingTotalRow.remove();

    const weftPatterns = results.weftPatterns.patterns || [];
    const weftDetails = formData.weftDetails || [];

    // Update existing rows with pattern data
    Array.from(tbody.querySelectorAll('tr:not(.total-row)')).forEach((row, index) => {
        const pattern = weftPatterns[index];
        if (pattern) {
            row.cells[6].textContent = pattern.repeatPicksPerColor.toFixed(2) || '0.00';
            row.cells[7].textContent = pattern.patternTotalPicks.toFixed(2) || '0.00';
            row.cells[8].textContent = pattern.greigeYarnRate.toFixed(1) || '0.0';
            row.cells[9].textContent = pattern.consumption.toFixed(4) || '0.0000';
            row.cells[10].textContent = pattern.yarnCost.toFixed(2) || '0.00';
            row.cells[11].textContent = pattern.colorCost.toFixed(2) || '0.00';
            row.cells[12].textContent = pattern.weftTotalCost.toFixed(2) || '0.00';
            row.cells[13].textContent = pattern.requiredGreige.toFixed(2) || '0.00';
            row.cells[14].innerHTML = '<button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button>';
        }
    });

    // Add total row
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
        <td>${(weftDetails.reduce((sum, d) => sum + (d.count || 0), 0) / weftDetails.length || 0).toFixed(2)}</td>
        <td>${(weftDetails.reduce((sum, d) => sum + (d.repeatBreakdown || 0), 0) || 0).toFixed(2)}</td>
        <td>-</td>
        <td>${(weftDetails.reduce((sum, d) => sum + (d.pickDensity || 0), 0) / weftDetails.length || 0).toFixed(2)}</td>
        <td>${(weftDetails.reduce((sum, d) => sum + (d.ratePerLbs || 0), 0) / weftDetails.length || 0).toFixed(2)}</td>
        <td>${(weftDetails.reduce((sum, d) => sum + (d.dyeingCostPerKg || 0), 0) / weftDetails.length || 0).toFixed(2)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.repeatPicksPerColor || 0), 0) || 0).toFixed(2)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.patternTotalPicks || 0), 0) || 0).toFixed(2)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.greigeYarnRate || 0), 0) / weftPatterns.length || 0).toFixed(1)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.consumption || 0), 0) || 0).toFixed(4)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.yarnCost || 0), 0) || 0).toFixed(2)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.colorCost || 0), 0) || 0).toFixed(2)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.weftTotalCost || 0), 0) || 0).toFixed(2)}</td>
        <td>${(weftPatterns.reduce((sum, p) => sum + (p.requiredGreige || 0), 0) || 0).toFixed(2)}</td>
        <td>-</td>
    `;
    tbody.appendChild(totalRow);
}

function updatePreCostResults(results) {
    const safeSetValue = (id, value, digits = 2) => {
        const element = document.getElementById(id);
        if (element) element.value = isFinite(value) ? value.toFixed(digits) : `0.${'0'.repeat(digits)}`;
    };

    safeSetValue('warpRepeatSize', results.patternSummary.warpRepeatSize);
    safeSetValue('weftRepeatSize', results.patternSummary.weftRepeatSize);
    safeSetValue('warpRepeatNumber', results.patternSummary.warpRepeatNumber);
    safeSetValue('weftRepeatNumber', results.patternSummary.weftRepeatNumber);
    safeSetValue('warpRepeatEnds', results.patternSummary.warpRepeatEnds);

    safeSetValue('greigeReqQuantity', results.orderParticulars.greigeReqQuantity);
    safeSetValue('requiredWarpKg', results.orderParticulars.requiredWarpKg);
    safeSetValue('requiredWeftKg', results.orderParticulars.requiredWeftKg);
    safeSetValue('totalRequiredKg', results.orderParticulars.totalRequiredKg);
    safeSetValue('warpGreigeConsump', results.orderParticulars.warpGreigeConsump, 3);
    safeSetValue('weftGreigeConsump', results.orderParticulars.weftGreigeConsump, 3);
    safeSetValue('totalGreigeConsump', results.orderParticulars.totalGreigeConsump, 3);
    safeSetValue('warpFinishConsump', results.orderParticulars.warpFinishConsump, 3);
    safeSetValue('weftFinishConsump', results.orderParticulars.weftFinishConsump, 3);
    safeSetValue('totalFinishConsump', results.orderParticulars.totalFinishConsump, 3);
    safeSetValue('greigeYarnCostPerYd', results.orderParticulars.greigeYarnCostPerYd);
    safeSetValue('warpYnCost', results.costBreakdown.warpYnCost);
    safeSetValue('weftYnCost', results.costBreakdown.weftYnCost);
    safeSetValue('totalGreigeCost', results.costBreakdown.totalGreigeCost);
    safeSetValue('yarnDyeCost', results.costBreakdown.yarnDyeCost);
    safeSetValue('totalYnCost', results.costBreakdown.totalYnCost);
    safeSetValue('weavingCost', results.costBreakdown.weavingCost);
    safeSetValue('breakEvenCostYd', results.costBreakdown.breakEvenCostYd);
    safeSetValue('salesPrice', results.costBreakdown.salesPrice);
    safeSetValue('upchargeSalesPrice', results.costBreakdown.upchargeSalesPrice);

    safeSetValue('totalGrWarpCost', results.budgetCost.totalGrWarpCost);
    safeSetValue('totalGrWarpCostPercent', results.budgetCost.totalGrWarpCostPercent);
    safeSetValue('totalGrWeftCost', results.budgetCost.totalGrWeftCost);
    safeSetValue('totalGrWeftCostPercent', results.budgetCost.totalGrWeftCostPercent);
    safeSetValue('graTotalGregCost', results.budgetCost.graTotalGregCost);
    safeSetValue('graTotalGregCostPercent', results.budgetCost.graTotalGregCostPercent);
    safeSetValue('totalYDyeingCost', results.budgetCost.totalYDyeingCost);
    safeSetValue('totalYDyeingCostPercent', results.budgetCost.totalYDyeingCostPercent);
    safeSetValue('totalWeavingCost', results.budgetCost.totalWeavingCost);
    safeSetValue('totalWeavingCostPercent', results.budgetCost.totalWeavingCostPercent);
    safeSetValue('totalDyeFinCost', results.budgetCost.totalDyeFinCost);
    safeSetValue('totalDyeFinCostPercent', results.budgetCost.totalDyeFinCostPercent);
    safeSetValue('totalCommercialCost', results.budgetCost.totalCommercialCost);
    safeSetValue('commercialCostPercent', results.budgetCost.commercialCostPercent);
    safeSetValue('grandTotalBECost', results.budgetCost.grandTotalBECost);
    safeSetValue('netBreakEvenCostPerYd', results.budgetCost.netBreakEvenCostPerYd);
    safeSetValue('netProfitPerYd', results.budgetCost.netProfitPerYd);
    safeSetValue('grandTotalProfit', results.budgetCost.grandTotalProfit);
    safeSetValue('grandTotalProfitPercent', results.budgetCost.grandTotalProfitPercent);
    safeSetValue('totalSalesValue', results.budgetCost.totalSalesValue);
    safeSetValue('upchargeNetProfit', results.budgetCost.upchargeNetProfit);
    safeSetValue('upchargeGrandTotalProfit', results.budgetCost.upchargeGrandTotalProfit);
    safeSetValue('upGrandTotalProfitPercent', results.budgetCost.upGrandTotalProfitPercent);
    safeSetValue('upchargeTotalSalesValue', results.budgetCost.upchargeTotalSalesValue);

    safeSetValue('totalPreCostTk', results.totalPreCostingValues.totalPreCostTk);
    safeSetValue('totalPreCostUSD', results.totalPreCostingValues.totalPreCostUSD);
    safeSetValue('totalUpchargePreCostTk', results.totalPreCostingValues.totalUpchargePreCostTk);
    safeSetValue('totalUpchargePreCostUSD', results.totalPreCostingValues.totalUpchargePreCostUSD);

    safeSetValue('warpTotalGSM', results.technicalSpecs.warpTotalGSM);
    safeSetValue('weftTotalGSM', results.technicalSpecs.weftTotalGSM);
    safeSetValue('totalGSM', results.technicalSpecs.totalGSM);
    safeSetValue('weightFinishFabric', results.technicalSpecs.weightFinishFabric);
    safeSetValue('warpCoverFactor', results.technicalSpecs.warpCoverFactor);
    safeSetValue('weftCoverFactor', results.technicalSpecs.weftCoverFactor);
    safeSetValue('totalCoverFactor', results.technicalSpecs.totalCoverFactor);
	
	// In updateWarpCalculationTable()
//console.log('Updated currentPreCostingData.warpDetails:', currentPreCostingData.warpDetails);

    // In updateWeftCalculationTable()
//console.log('Updated currentPreCostingData.weftDetails:', currentPreCostingData.weftDetails);

    console.log('Updated currentPreCostingData.warpDetails:', currentPreCostingData?.warpDetails || 'Not available');
    console.log('Updated currentPreCostingData.weftDetails:', currentPreCostingData?.weftDetails || 'Not available');
}

function calculateForm() {
    if (!isLoggedIn) {
        console.log('User not logged in, skipping calculation');
        return;
    }
    try {
	
	    // Ensure currentPreCostingData has the required structure
        if (!currentPreCostingData) {
            currentPreCostingData = {
                preCostingData: null,
                warpDetails: [],
                weftDetails: []
            };
        }
		
        const formData = getFormData();
        console.log('Calculating with Form Data:', formData);
        const results = PreCostingCalculator.calculateFullPreCosting(formData);
        console.log('Calculation Results:', {
            orderParticulars: results.orderParticulars,
            costBreakdown: results.costBreakdown,
            patternSummary: results.patternSummary,
            totalPreCostingValues: results.totalPreCostingValues,
            warpPatterns: results.warpPatterns,
            weftPatterns: results.weftPatterns
        });
        console.log('Budget Costs:', {
            totalGrWarpCost: results.budgetCost.totalGrWarpCost,
            totalGrWarpCostPercent: results.budgetCost.totalGrWarpCostPercent,
            totalGrWeftCost: results.budgetCost.totalGrWeftCost,
            totalGrWeftCostPercent: results.budgetCost.totalGrWeftCostPercent,
            graTotalGregCost: results.budgetCost.graTotalGregCost,
            graTotalGregCostPercent: results.budgetCost.graTotalGregCostPercent,
            totalYDyeingCost: results.budgetCost.totalYDyeingCost,
            totalYDyeingCostPercent: results.budgetCost.totalYDyeingCostPercent,
            totalWeavingCost: results.budgetCost.totalWeavingCost,
            totalWeavingCostPercent: results.budgetCost.totalWeavingCostPercent,
            totalDyeFinCost: results.budgetCost.totalDyeFinCost,
            totalDyeFinCostPercent: results.budgetCost.totalDyeFinCostPercent,
            totalCommercialCost: results.budgetCost.totalCommercialCost,
            commercialCostPercent: results.budgetCost.commercialCostPercent,
            grandTotalBECost: results.budgetCost.grandTotalBECost,
            netBreakEvenCostPerYd: results.budgetCost.netBreakEvenCostPerYd,
            netProfitPerYd: results.budgetCost.netProfitPerYd,
            grandTotalProfit: results.budgetCost.grandTotalProfit,
            grandTotalProfitPercent: results.budgetCost.grandTotalProfitPercent,
            totalSalesValue: results.budgetCost.totalSalesValue,
            upchargeNetProfit: results.budgetCost.upchargeNetProfit,
            upchargeGrandTotalProfit: results.budgetCost.upchargeGrandTotalProfit,
            upGrandTotalProfitPercent: results.budgetCost.upGrandTotalProfitPercent,
            upchargeTotalSalesValue: results.budgetCost.upchargeTotalSalesValue
        });

        updateWarpCalculationTable(results, formData);
        updateWeftCalculationTable(results, formData);
        updatePreCostResults(results);
        console.log('Form calculation completed successfully');
    } catch (error) {
        console.error('Error during calculation:', error);
        alert('An error occurred during calculation. Please check your inputs.');
    }
}

// Populate dropdown with Pre Costing Numbers from Supabase
async function populatePreCostingDropdown() {
    if (!isLoggedIn) {
        console.log('User not logged in, skipping dropdown population');
        return;
    }
    try {
        const { data, error } = await supabase
            .from('pre_costing_data')
            .select('pre_costing_no')
            .order('pre_costing_no', { ascending: true });

        if (error) throw error;

        const dropdown = document.getElementById('preCostingDropdown');
        dropdown.innerHTML = '<option value="">Select Pre-costing No</option>';
        if (data && data.length > 0) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.pre_costing_no;
                option.textContent = item.pre_costing_no; // Displays "Pre/costing/No:XXXXXXXX"
                dropdown.appendChild(option);
            });
            console.log('Dropdown populated with', data.length, 'options');
        } else {
            console.log('No pre-costing numbers found in database');
        }
    } catch (error) {
        console.error('Error populating dropdown:', error);
        alert('Failed to load pre-costing numbers.');
		const dropdown = document.getElementById('preCostingDropdown');
        dropdown.innerHTML = '<option value="">Select Pre-costing No (Offline)</option>';
    }
}

// Search and autofill form based on selected Pre Costing No
async function searchPreCosting() {
    if (!isLoggedIn) {
        alert('Please log in to perform this action.');
        return;
    }
    const selectedPreCostingNo = document.getElementById('preCostingDropdown').value;
    if (!selectedPreCostingNo) {
        alert('Please select a Pre-costing No to search.');
        return;
    }

    try {
        console.log('Searching for pre-costing No:', selectedPreCostingNo);
        const { data, error } = await supabase
            .from('pre_costing_data')
            .select('*')
            .eq('pre_costing_no', selectedPreCostingNo)
            .single();

        if (error) throw error;
        if (!data) {
            console.log('No data found for pre-costing No:', selectedPreCostingNo);
            throw new Error('No data found for the selected Pre-costing No.');
        }

        console.log('Search data retrieved:', data);

        const { data: warpData, error: warpError } = await supabase
            .from('warp_details')
            .select('*')
            .eq('pre_costing_no', selectedPreCostingNo);

        if (warpError) throw warpError;

        const { data: weftData, error: weftError } = await supabase
            .from('weft_details')
            .select('*')
            .eq('pre_costing_no', selectedPreCostingNo);

        if (weftError) throw weftError;

        currentPreCostingData = {
            preCostingData: data,
            warpDetails: warpData,
            weftDetails: weftData
        };

        // Set the full pre_costing_no value
        document.getElementById('preCostingNo').value = data.pre_costing_no;
        document.getElementById('buyer').value = data.buyer || '';
        document.getElementById('construction').value = data.construction || '';
        document.getElementById('finishWidth').value = data.finish_width || '';
        document.getElementById('totalEnds').value = data.total_ends || '';
        document.getElementById('warpCrimp').value = data.warp_crimp || '';
        document.getElementById('ydAllow').value = data.yd_allow || '';
        document.getElementById('warpWast').value = data.warp_wast || '';
        document.getElementById('weftWast').value = data.weft_wast || '';
        document.getElementById('finishAllow').value = data.finish_allow || '';
        document.getElementById('weavingPickRate').value = data.weaving_rate || '';
        document.getElementById('dyeingFinishingRate').value = data.dye_finish_rate || '';
        document.getElementById('commercialCostInput').value = data.commercial_cost || '';
        document.getElementById('profit').value = data.profit || '';
        document.getElementById('epi').value = data.epi || '';
        document.getElementById('ppi').value = data.ppi || '';
        document.getElementById('weaveType').value = data.weave_type || '';
        document.getElementById('greigeWidth').value = data.greige_width || '';
        document.getElementById('weftCrimp').value = data.weft_crimp || '';
        document.getElementById('orderQuantity').value = data.order_quantity || '';
        document.getElementById('pickLength').value = data.pick_length || '';
        document.getElementById('dollarRateTk').value = data.dollar_rate_tk || '';
        document.getElementById('preCostingDate').value = data.pre_costing_date || '';

        document.getElementById('greigeReqQuantity').value = data.greige_req_quantity || '';
        document.getElementById('requiredWarpKg').value = data.required_warp_yarn || '';
        document.getElementById('requiredWeftKg').value = data.required_weft_yarn || '';
        document.getElementById('totalRequiredKg').value = data.total_required_yarn || '';
        document.getElementById('warpGreigeConsump').value = data.warp_greige_consump || '';
        document.getElementById('weftGreigeConsump').value = data.weft_greige_consump || '';
        document.getElementById('totalGreigeConsump').value = data.total_greige_consump || '';
        document.getElementById('warpFinishConsump').value = data.warp_finish_consump || '';
        document.getElementById('weftFinishConsump').value = data.weft_finish_consump || '';
        document.getElementById('totalFinishConsump').value = data.total_finish_consump || '';
        document.getElementById('greigeYarnCostPerYd').value = data.total_greige_yarn_cost_per_yd || '';
        document.getElementById('warpYnCost').value = data.warp_yarn_cost || '';
        document.getElementById('weftYnCost').value = data.weft_yarn_cost || '';
        document.getElementById('totalGreigeCost').value = data.greige_cost || '';
        document.getElementById('yarnDyeCost').value = data.yarn_dyeing_cost || '';
        document.getElementById('totalYnCost').value = data.total_yarn_cost || '';
        document.getElementById('weavingCost').value = data.weaving_cost || '';
        document.getElementById('breakEvenCostYd').value = data.break_even_cost || '';
        document.getElementById('salesPrice').value = data.sales_price || '';
        document.getElementById('upchargeSalesPrice').value = data.upcharged_sales_price || '';
        document.getElementById('totalGrWarpCost').value = data.total_warp_cost || '';
        document.getElementById('totalGrWeftCost').value = data.total_weft_cost || '';
        document.getElementById('graTotalGregCost').value = data.total_greige_cost || '';
        document.getElementById('totalYDyeingCost').value = data.total_dyeing_cost || '';
        document.getElementById('totalWeavingCost').value = data.total_weaving_cost || '';
        document.getElementById('totalDyeFinCost').value = data.total_dye_finish_cost || '';
        document.getElementById('totalCommercialCost').value = data.total_commercial_cost || '';
        document.getElementById('grandTotalBECost').value = data.grand_total_break_even_cost || '';
        document.getElementById('netBreakEvenCostPerYd').value = data.net_break_even_cost_per_yd || '';
        document.getElementById('netProfitPerYd').value = data.net_profit_per_yd || '';
        document.getElementById('grandTotalProfit').value = data.grand_total_profit || '';
        document.getElementById('totalSalesValue').value = data.total_sales_value || '';
        document.getElementById('upchargeNetProfit').value = data.upcharged_net_profit_per_yd || '';
        document.getElementById('upchargeGrandTotalProfit').value = data.upcharged_grand_total_profit || '';
        document.getElementById('upchargeTotalSalesValue').value = data.upcharged_total_sales_value || '';
        document.getElementById('totalPreCostTk').value = data.total_pre_cost_tk || '';
        document.getElementById('totalPreCostUSD').value = data.total_pre_cost_usd || '';
        document.getElementById('totalUpchargePreCostTk').value = data.total_upcharged_pre_cost_tk || '';
        document.getElementById('totalUpchargePreCostUSD').value = data.total_upcharged_pre_cost_usd || '';

        const warpTbody = document.getElementById('warpCalculationTable').querySelector('tbody');
        const weftTbody = document.getElementById('weftCalculationTable').querySelector('tbody');
        warpTbody.innerHTML = '';
        weftTbody.innerHTML = '';

        if (warpData && warpData.length > 0) {
            warpData.forEach(warpDetail => {
                const newRow = document.createElement('tr');
                newRow.className = 'pattern-row';
                newRow.innerHTML = `
                    <td><input type="number" class="form-control" value="${warpDetail.warp_count || ''}"></td>
                    <td><input type="number" class="form-control" value="${warpDetail.repeat_breakdown || ''}"></td>
                    <td><input type="text" class="form-control" value="${warpDetail.color_name || ''}"></td>
                    <td><input type="number" class="form-control" value="${warpDetail.denting || ''}"></td>
                    <td><input type="number" class="form-control" value="${warpDetail.rate_per_lbs || ''}"></td>
                    <td><input type="number" class="form-control" value="${warpDetail.dyeing_cost_per_kg || ''}"></td>
                    <td class="result-cell">${warpDetail.repeat_ends_per_color || '0.00'}</td>
                    <td class="result-cell">${warpDetail.pattern_total_ends || '0.00'}</td>
                    <td class="result-cell">${warpDetail.dent_numbers_in_full_width || '0.00'}</td>
                    <td class="result-cell">${warpDetail.greige_yarn_rate || '0.0'}</td>
                    <td class="result-cell">${warpDetail.consumption || '0.0000'}</td>
                    <td class="result-cell">${warpDetail.yarn_cost || '0.00'}</td>
                    <td class="result-cell">${warpDetail.color_cost || '0.00'}</td>
                    <td class="result-cell">${warpDetail.warp_total_cost || '0.00'}</td>
                    <td class="result-cell">${warpDetail.required_greige || '0.00'}</td>
                    <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                `;
                warpTbody.appendChild(newRow);
            });
        } else {
            addEmptyWarpRow(warpTbody);
        }

        if (weftData && weftData.length > 0) {
            weftData.forEach(weftDetail => {
                const newRow = document.createElement('tr');
                newRow.className = 'pattern-row';
                newRow.innerHTML = `
                    <td><input type="number" class="form-control" value="${weftDetail.weft_count || ''}"></td>
                    <td><input type="number" class="form-control" value="${weftDetail.repeat_breakdown || ''}"></td>
                    <td><input type="text" class="form-control" value="${weftDetail.color_name || ''}"></td>
                    <td><input type="number" class="form-control" value="${weftDetail.pick_density || ''}"></td>
                    <td><input type="number" class="form-control" value="${weftDetail.rate_per_lbs || ''}"></td>
                    <td><input type="number" class="form-control" value="${weftDetail.dyeing_cost_per_kg || ''}"></td>
                    <td class="result-cell">${weftDetail.repeat_picks_per_color || '0.00'}</td>
                    <td class="result-cell">${weftDetail.pattern_total_picks || '0.00'}</td>
                    <td class="result-cell">${weftDetail.greige_yarn_rate || '0.0'}</td>
                    <td class="result-cell">${weftDetail.consumption || '0.0000'}</td>
                    <td class="result-cell">${weftDetail.yarn_cost || '0.00'}</td>
                    <td class="result-cell">${weftDetail.color_cost || '0.00'}</td>
                    <td class="result-cell">${weftDetail.weft_total_cost || '0.00'}</td>
                    <td class="result-cell">${weftDetail.required_greige || '0.00'}</td>
                    <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                `;
                weftTbody.appendChild(newRow);
            });
        } else {
            addEmptyWeftRow(weftTbody);
        }
		calculateForm(); // it can be removed to avoid recalculating, as we want to use the Supabase data as-is
        // alert('Pre-costing data loaded successfully!');
    } catch (error) {
        console.error('Error searching pre-costing:', error);
        alert(`Failed to load pre-costing data: ${error.message}`);
    }
}



// Save data to Supabase PostgreSQL
async function saveToPostgreSQL() {
    if (!isLoggedIn) {
        alert('Please log in to perform this action.');
        return;
    }
    try {
        // Generate the next pre-costing number if it's a new entry
        let preCostingNo = document.getElementById('preCostingNo').value;
        const { data: existingData, error: checkError } = await supabase
            .from('pre_costing_data')
            .select('pre_costing_no')
            .eq('pre_costing_no', preCostingNo)
            .single();

        if (checkError && checkError.code !== 'PGRST116') throw checkError;

        if (!existingData) {
            preCostingNo = await generateNextPreCostingNo();
            document.getElementById('preCostingNo').value = preCostingNo;
        }

        const formData = getFormData();
        const results = PreCostingCalculator.calculateFullPreCosting(formData);

        // Prepare data for pre_costing_data table
        const dataToSave = {
            pre_costing_no: preCostingNo,
            buyer: results.inputSummary.buyer,
            construction: results.inputSummary.construction,
            finish_width: results.inputSummary.finishWidth,
            total_ends: results.inputSummary.totalEnds,
            warp_crimp: results.inputSummary.warpCrimp,
            yd_allow: results.inputSummary.ydAllow,
            warp_wast: results.inputSummary.warpWast,
            weft_wast: results.inputSummary.weftWast,
            finish_allow: results.inputSummary.finishAllow,
            weaving_rate: results.inputSummary.weavingPickRate,
            dye_finish_rate: results.inputSummary.dyeingFinishingRate,
            commercial_cost: results.inputSummary.commercialCostInput,
            profit: results.inputSummary.profit,
            greige_req_quantity: results.orderParticulars.greigeReqQuantity,
            required_warp_yarn: results.orderParticulars.requiredWarpKg,
            required_weft_yarn: results.orderParticulars.requiredWeftKg,
            total_required_yarn: results.orderParticulars.totalRequiredKg,
            warp_greige_consump: results.orderParticulars.warpGreigeConsump,
            weft_greige_consump: results.orderParticulars.weftGreigeConsump,
            total_greige_consump: results.orderParticulars.totalGreigeConsump,
            warp_finish_consump: results.orderParticulars.warpFinishConsump,
            weft_finish_consump: results.orderParticulars.weftFinishConsump,
            total_finish_consump: results.orderParticulars.totalFinishConsump,
            total_greige_yarn_cost_per_yd: results.orderParticulars.greigeYarnCostPerYd,
            warp_yarn_cost: results.costBreakdown.warpYnCost,
            weft_yarn_cost: results.costBreakdown.weftYnCost,
            greige_cost: results.costBreakdown.totalGreigeCost,
            yarn_dyeing_cost: results.costBreakdown.yarnDyeCost,
            total_yarn_cost: results.costBreakdown.totalYnCost,
            weaving_cost: results.costBreakdown.weavingCost,
            break_even_cost: results.costBreakdown.breakEvenCostYd,
            sales_price: results.costBreakdown.salesPrice,
            upcharged_sales_price: results.costBreakdown.upchargeSalesPrice,
            total_warp_cost: results.budgetCost.totalGrWarpCost,
            total_weft_cost: results.budgetCost.totalGrWeftCost,
            total_greige_cost: results.budgetCost.graTotalGregCost,
            total_dyeing_cost: results.budgetCost.totalYDyeingCost,
            total_weaving_cost: results.budgetCost.totalWeavingCost,
            total_dye_finish_cost: results.budgetCost.totalDyeFinCost,
            total_commercial_cost: results.budgetCost.totalCommercialCost,
            grand_total_break_even_cost: results.budgetCost.grandTotalBECost,
            net_break_even_cost_per_yd: results.budgetCost.netBreakEvenCostPerYd,
            net_profit_per_yd: results.budgetCost.netProfitPerYd,
            grand_total_profit: results.budgetCost.grandTotalProfit,
            total_sales_value: results.budgetCost.totalSalesValue,
            upcharged_net_profit_per_yd: results.budgetCost.upchargeNetProfit,
            upcharged_grand_total_profit: results.budgetCost.upchargeGrandTotalProfit,
            upcharged_total_sales_value: results.budgetCost.upchargeTotalSalesValue,
            total_pre_cost_tk: results.totalPreCostingValues.totalPreCostTk,
            total_pre_cost_usd: results.totalPreCostingValues.totalPreCostUSD,
            total_upcharged_pre_cost_tk: results.totalPreCostingValues.totalUpchargePreCostTk,
            total_upcharged_pre_cost_usd: results.totalPreCostingValues.totalUpchargePreCostUSD,
            order_quantity: results.inputSummary.orderQuantity,
            pick_length: results.inputSummary.pickLength,
            pre_costing_date: results.inputSummary.preCostingDate,
            dollar_rate_tk: results.inputSummary.dollarRateTk,
            epi: results.inputSummary.epi,
            ppi: results.inputSummary.ppi,
            weave_type: results.inputSummary.weaveType,
            weft_crimp: results.inputSummary.weftCrimp,
            greige_width: results.inputSummary.greigeWidth
        };

        const { data: savedData, error: saveError } = await supabase
            .from('pre_costing_data')
            .upsert([dataToSave], { onConflict: 'pre_costing_no' })
            .select();

        if (saveError) throw saveError;
        console.log('Saved to pre_costing_data:', savedData);

        // Prepare and save Warp Details with result fields
        const warpDetailsToSave = formData.warpDetails.map((detail, index) => {
            const pattern = results.warpPatterns.patterns[index] || {};
            return {
                pre_costing_no: preCostingNo,
                warp_count: detail.count,
                repeat_breakdown: detail.repeatBreakdown,
                color_name: detail.colorName,
                denting: detail.denting,
                rate_per_lbs: detail.ratePerLbs,
                dyeing_cost_per_kg: detail.dyeingCostPerKg,
                repeat_ends_per_color: pattern.repeatEndsPerColor || 0,
                pattern_total_ends: pattern.patternTotalEnds || 0,
                dent_numbers_in_full_width: pattern.dentNumbersInFullWidth || 0,
                greige_yarn_rate: pattern.greigeYarnRate || 0,
                consumption: pattern.consumption || 0,
                yarn_cost: pattern.yarnCost || 0,
                color_cost: pattern.colorCost || 0,
                warp_total_cost: pattern.warpTotalCost || 0,
                required_greige: pattern.requiredGreige || 0
            };
        });

        const { error: deleteWarpError } = await supabase
            .from('warp_details')
            .delete()
            .eq('pre_costing_no', preCostingNo);

        if (deleteWarpError) throw deleteWarpError;

        if (warpDetailsToSave.length > 0) {
            const { error: warpError } = await supabase
                .from('warp_details')
                .insert(warpDetailsToSave);

            if (warpError) throw warpError;
            console.log('Saved warp details:', warpDetailsToSave);
        }

        // Prepare and save Weft Details with result fields
        const weftDetailsToSave = formData.weftDetails.map((detail, index) => {
            const pattern = results.weftPatterns.patterns[index] || {};
            return {
                pre_costing_no: preCostingNo,
                weft_count: detail.count,
                repeat_breakdown: detail.repeatBreakdown,
                color_name: detail.colorName,
                pick_density: detail.pickDensity,
                rate_per_lbs: detail.ratePerLbs,
                dyeing_cost_per_kg: detail.dyeingCostPerKg,
                repeat_picks_per_color: pattern.repeatPicksPerColor || 0,
                pattern_total_picks: pattern.patternTotalPicks || 0,
                greige_yarn_rate: pattern.greigeYarnRate || 0,
                consumption: pattern.consumption || 0,
                yarn_cost: pattern.yarnCost || 0,
                color_cost: pattern.colorCost || 0,
                weft_total_cost: pattern.weftTotalCost || 0,
                required_greige: pattern.requiredGreige || 0
            };
        });

        const { error: deleteWeftError } = await supabase
            .from('weft_details')
            .delete()
            .eq('pre_costing_no', preCostingNo);

        if (deleteWeftError) throw deleteWeftError;

        if (weftDetailsToSave.length > 0) {
            const { error: weftError } = await supabase
                .from('weft_details')
                .insert(weftDetailsToSave);

            if (weftError) throw weftError;
            console.log('Saved weft details:', weftDetailsToSave);
        }

        await populatePreCostingDropdown();

        // Clear currentPreCostingData to ensure export functions use the latest data
        currentPreCostingData = null;

        alert('Data saved successfully to Supabase!');
        console.log('Data saved successfully with pre_costing_no:', preCostingNo);
    } catch (error) {
        console.error('Error saving to Supabase:', error);
        alert(`Failed to save data: ${error.message}`);
    }
}

// Export to CSV
function exportToCSV() {
    if (!isLoggedIn) {
        alert('Please log in to perform this action.');
        return;
    }
	calculateForm(); // Ensure calculations are up-to-date
    if (!currentPreCostingData) {
        alert('No pre-costing data loaded. Please search for a pre-costing number first.');
        return;
    }
    if (!currentPreCostingData) {
        alert('No pre-costing data loaded. Please search for a pre-costing number first.');
        return;
    }

    const { preCostingData, warpDetails, weftDetails } = currentPreCostingData;

    // Calculate Warp Details totals
    const warpTotals = {
        pattern_total_ends: 0,
        dent_numbers_in_full_width: 0,
        greige_yarn_rate: 0,
        consumption: 0,
        yarn_cost: 0,
        color_cost: 0,
        warp_total_cost: 0,
        required_greige: 0
    };
    warpDetails.forEach(detail => {
        warpTotals.pattern_total_ends += detail.pattern_total_ends || 0;
        warpTotals.dent_numbers_in_full_width += detail.dent_numbers_in_full_width || 0;
        warpTotals.greige_yarn_rate += detail.greige_yarn_rate || 0;
        warpTotals.consumption += detail.consumption || 0;
        warpTotals.yarn_cost += detail.yarn_cost || 0;
        warpTotals.color_cost += detail.color_cost || 0;
        warpTotals.warp_total_cost += detail.warp_total_cost || 0;
        warpTotals.required_greige += detail.required_greige || 0;
    });

    // Calculate Weft Details totals
    const weftTotals = {
        pattern_total_picks: 0,
        greige_yarn_rate: 0,
        consumption: 0,
        yarn_cost: 0,
        color_cost: 0,
        weft_total_cost: 0,
        required_greige: 0
    };
    weftDetails.forEach(detail => {
        weftTotals.pattern_total_picks += detail.pattern_total_picks || 0;
        weftTotals.greige_yarn_rate += detail.greige_yarn_rate || 0;
        weftTotals.consumption += detail.consumption || 0;
        weftTotals.yarn_cost += detail.yarn_cost || 0;
        weftTotals.color_cost += detail.color_cost || 0;
        weftTotals.weft_total_cost += detail.weft_total_cost || 0;
        weftTotals.required_greige += detail.required_greige || 0;
    });

    // CSV content
    let csvContent = '';

    // Pre-costing Data
    csvContent += 'Pre Costing Data\n';
    csvContent += 'Pre Costing No,Buyer,Construction,Finish Width,Total Ends,Warp Crimp,YD Allow,Warp Wast,Weft Wast,Finish Allow,Weaving Pick Rate,Dyeing Finishing Rate,Commercial Cost,Profit,Order Quantity,Pick Length,Pre Costing Date,Dollar Rate Tk,EPI,PPI,Weave Type,Weft Crimp,Greige Width\n';
    csvContent += `${preCostingData.pre_costing_no},${preCostingData.buyer},${preCostingData.construction},${preCostingData.finish_width},${preCostingData.total_ends},${preCostingData.warp_crimp},${preCostingData.yd_allow},${preCostingData.warp_wast},${preCostingData.weft_wast},${preCostingData.finish_allow},${preCostingData.weaving_rate},${preCostingData.dye_finish_rate},${preCostingData.commercial_cost},${preCostingData.profit},${preCostingData.order_quantity},${preCostingData.pick_length},${preCostingData.pre_costing_date},${preCostingData.dollar_rate_tk},${preCostingData.epi},${preCostingData.ppi},${preCostingData.weave_type},${preCostingData.weft_crimp},${preCostingData.greige_width}\n\n`;

    // Warp Details
    csvContent += 'Warp Details\n';
    csvContent += 'Count,Repeat Breakdown,Color Name,Denting,Rate Per Lbs,Dyeing Cost Per Kg,Repeat Ends Per Color,Pattern Total Ends,Dent Numbers In Full Width,Greige Yarn Rate,Consumption,Yarn Cost,Color Cost,Warp Total Cost,Required Greige\n';
    warpDetails.forEach(detail => {
        csvContent += `${detail.warp_count},${detail.repeat_breakdown},${detail.color_name},${detail.denting},${detail.rate_per_lbs},${detail.dyeing_cost_per_kg},${detail.repeat_ends_per_color || 0},${detail.pattern_total_ends || 0},${detail.dent_numbers_in_full_width || 0},${detail.greige_yarn_rate || 0},${detail.consumption || 0},${detail.yarn_cost || 0},${detail.color_cost || 0},${detail.warp_total_cost || 0},${detail.required_greige || 0}\n`;
    });
    // Add Warp Totals
    csvContent += `Total,,,,,,${warpTotals.pattern_total_ends.toFixed(2)},${warpTotals.pattern_total_ends.toFixed(2)},${warpTotals.dent_numbers_in_full_width.toFixed(2)},${warpTotals.greige_yarn_rate.toFixed(1)},${warpTotals.consumption.toFixed(4)},${warpTotals.yarn_cost.toFixed(2)},${warpTotals.color_cost.toFixed(2)},${warpTotals.warp_total_cost.toFixed(2)},${warpTotals.required_greige.toFixed(2)}\n\n`;

    // Weft Details
    csvContent += 'Weft Details\n';
    csvContent += 'Count,Repeat Breakdown,Color Name,Pick Density,Rate Per Lbs,Dyeing Cost Per Kg,Repeat Picks Per Color,Pattern Total Picks,Greige Yarn Rate,Consumption,Yarn Cost,Color Cost,Weft Total Cost,Required Greige\n';
    weftDetails.forEach(detail => {
        csvContent += `${detail.weft_count},${detail.repeat_breakdown},${detail.color_name},${detail.pick_density},${detail.rate_per_lbs},${detail.dyeing_cost_per_kg},${detail.repeat_picks_per_color || 0},${detail.pattern_total_picks || 0},${detail.greige_yarn_rate || 0},${detail.consumption || 0},${detail.yarn_cost || 0},${detail.color_cost || 0},${detail.weft_total_cost || 0},${detail.required_greige || 0}\n`;
    });
    // Add Weft Totals
    csvContent += `Total,,,,,,${weftTotals.pattern_total_picks.toFixed(2)},${weftTotals.pattern_total_picks.toFixed(2)},${weftTotals.greige_yarn_rate.toFixed(1)},${weftTotals.consumption.toFixed(4)},${weftTotals.yarn_cost.toFixed(2)},${weftTotals.color_cost.toFixed(2)},${weftTotals.weft_total_cost.toFixed(2)},${weftTotals.required_greige.toFixed(2)}\n`;

    // Create and download the CSV file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `PreCosting_${preCostingData.pre_costing_no.replace('Pre/costing/No:', '')}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
	
}

// Export to SQL
function exportToSQL() {
    if (!isLoggedIn) {
        alert('Please log in to perform this action.');
        return;
    }
	calculateForm(); // Ensure calculations are up-to-date
    if (!currentPreCostingData) {
        alert('No pre-costing data loaded. Please search for a pre-costing number first.');
        return;
    }
    if (!currentPreCostingData) {
        alert('No pre-costing data loaded. Please search for a pre-costing number first.');
        return;
    }

    const { preCostingData, warpDetails, weftDetails } = currentPreCostingData;

    // Calculate Warp Details totals
    const warpTotals = {
        pattern_total_ends: 0,
        dent_numbers_in_full_width: 0,
        greige_yarn_rate: 0,
        consumption: 0,
        yarn_cost: 0,
        color_cost: 0,
        warp_total_cost: 0,
        required_greige: 0
    };
    warpDetails.forEach(detail => {
        warpTotals.pattern_total_ends += detail.pattern_total_ends || 0;
        warpTotals.dent_numbers_in_full_width += detail.dent_numbers_in_full_width || 0;
        warpTotals.greige_yarn_rate += detail.greige_yarn_rate || 0;
        warpTotals.consumption += detail.consumption || 0;
        warpTotals.yarn_cost += detail.yarn_cost || 0;
        warpTotals.color_cost += detail.color_cost || 0;
        warpTotals.warp_total_cost += detail.warp_total_cost || 0;
        warpTotals.required_greige += detail.required_greige || 0;
    });

    // Calculate Weft Details totals
    const weftTotals = {
        pattern_total_picks: 0,
        greige_yarn_rate: 0,
        consumption: 0,
        yarn_cost: 0,
        color_cost: 0,
        weft_total_cost: 0,
        required_greige: 0
    };
    weftDetails.forEach(detail => {
        weftTotals.pattern_total_picks += detail.pattern_total_picks || 0;
        weftTotals.greige_yarn_rate += detail.greige_yarn_rate || 0;
        weftTotals.consumption += detail.consumption || 0;
        weftTotals.yarn_cost += detail.yarn_cost || 0;
        weftTotals.color_cost += detail.color_cost || 0;
        weftTotals.weft_total_cost += detail.weft_total_cost || 0;
        weftTotals.required_greige += detail.required_greige || 0;
    });

    // SQL content
    let sqlContent = '';

    // Warp Details
    warpDetails.forEach(detail => {
        sqlContent += `INSERT INTO warp_details (
            pre_costing_no, warp_count, repeat_breakdown, color_name, denting,
            rate_per_lbs, dyeing_cost_per_kg, repeat_ends_per_color, pattern_total_ends,
            dent_numbers_in_full_width, greige_yarn_rate, consumption, yarn_cost,
            color_cost, warp_total_cost, required_greige
        ) VALUES (
            '${detail.pre_costing_no}', ${detail.warp_count}, ${detail.repeat_breakdown}, '${detail.color_name}', ${detail.denting},
            ${detail.rate_per_lbs}, ${detail.dyeing_cost_per_kg}, ${detail.repeat_ends_per_color || 0}, ${detail.pattern_total_ends || 0},
            ${detail.dent_numbers_in_full_width || 0}, ${detail.greige_yarn_rate || 0}, ${detail.consumption || 0}, ${detail.yarn_cost || 0},
            ${detail.color_cost || 0}, ${detail.warp_total_cost || 0}, ${detail.required_greige || 0}
        );\n`;
    });

    // Weft Details
    weftDetails.forEach(detail => {
        sqlContent += `INSERT INTO weft_details (
            pre_costing_no, weft_count, repeat_breakdown, color_name, pick_density,
            rate_per_lbs, dyeing_cost_per_kg, repeat_picks_per_color, pattern_total_picks,
            greige_yarn_rate, consumption, yarn_cost, color_cost, weft_total_cost,
            required_greige
        ) VALUES (
            '${detail.pre_costing_no}', ${detail.weft_count}, ${detail.repeat_breakdown}, '${detail.color_name}', ${detail.pick_density},
            ${detail.rate_per_lbs}, ${detail.dyeing_cost_per_kg}, ${detail.repeat_picks_per_color || 0}, ${detail.pattern_total_picks || 0},
            ${detail.greige_yarn_rate || 0}, ${detail.consumption || 0}, ${detail.yarn_cost || 0}, ${detail.color_cost || 0},
            ${detail.weft_total_cost || 0}, ${detail.required_greige || 0}
        );\n`;
    });

    // Add comments for totals (not inserted into the database, but included for reference)
    sqlContent += `\n-- Warp Totals\n`;
    sqlContent += `-- Pattern Total Ends: ${warpTotals.pattern_total_ends.toFixed(2)}\n`;
    sqlContent += `-- Dent Numbers In Full Width: ${warpTotals.dent_numbers_in_full_width.toFixed(2)}\n`;
    sqlContent += `-- Greige Yarn Rate: ${warpTotals.greige_yarn_rate.toFixed(1)}\n`;
    sqlContent += `-- Consumption: ${warpTotals.consumption.toFixed(4)}\n`;
    sqlContent += `-- Yarn Cost: ${warpTotals.yarn_cost.toFixed(2)}\n`;
    sqlContent += `-- Color Cost: ${warpTotals.color_cost.toFixed(2)}\n`;
    sqlContent += `-- Warp Total Cost: ${warpTotals.warp_total_cost.toFixed(2)}\n`;
    sqlContent += `-- Required Greige: ${warpTotals.required_greige.toFixed(2)}\n`;

    sqlContent += `\n-- Weft Totals\n`;
    sqlContent += `-- Pattern Total Picks: ${weftTotals.pattern_total_picks.toFixed(2)}\n`;
    sqlContent += `-- Greige Yarn Rate: ${weftTotals.greige_yarn_rate.toFixed(1)}\n`;
    sqlContent += `-- Consumption: ${weftTotals.consumption.toFixed(4)}\n`;
    sqlContent += `-- Yarn Cost: ${weftTotals.yarn_cost.toFixed(2)}\n`;
    sqlContent += `-- Color Cost: ${weftTotals.color_cost.toFixed(2)}\n`;
    sqlContent += `-- Weft Total Cost: ${weftTotals.weft_total_cost.toFixed(2)}\n`;
    sqlContent += `-- Required Greige: ${weftTotals.required_greige.toFixed(2)}\n`;

    // Create and download the SQL file
    const blob = new Blob([sqlContent], { type: 'text/sql;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `PreCosting_${preCostingData.pre_costing_no.replace('Pre/costing/No:', '')}.sql`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// Save locally (to localStorage)
function saveLocally() {
    if (!isLoggedIn) {
        alert('Please log in to perform this action.');
        return;
    }

    const formData = getFormData();
    let savedData = JSON.parse(localStorage.getItem('preCostingSavedData')) || [];

    const existingIndex = savedData.findIndex(data => data.preCostingNo === formData.preCostingNo);
    if (existingIndex !== -1) {
        savedData[existingIndex] = formData;
    } else {
        savedData.push(formData);
    }

    localStorage.setItem('preCostingSavedData', JSON.stringify(savedData));

    // Extract the numeric part for the file name
    const preCostingNumber = formData.preCostingNo.replace('Pre/costing/No:', '');

    const jsonString = JSON.stringify(formData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `PreCosting_${preCostingNumber}.json`); // Use the numeric part
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log('Saved Data:', savedData);
}

// Show load modal with saved data
function showLoadModal() {
    if (!isLoggedIn) {
        alert('Please log in to perform this action.');
        return;
    }

    const loadList = document.getElementById('loadList');
    if (!loadList) {
        console.error('loadList element not found. Please ensure the modal HTML is correct.');
        return;
    }

    let savedData = JSON.parse(localStorage.getItem('preCostingSavedData')) || [];
    loadList.innerHTML = '';

    if (savedData.length === 0) {
        loadList.innerHTML = '<li class="list-group-item">No saved data found in session.</li>';
    } else {
        savedData.forEach((data, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                Pre Costing No: ${data.preCostingNo} (Saved on ${new Date().toLocaleString()})
                <div>
                    <button class="btn btn-sm btn-primary load-data-btn me-2" data-index="${index}">Load</button>
                    <button class="btn btn-sm btn-danger delete-data-btn" data-index="${index}">Delete</button>
                </div>
            `;
            loadList.appendChild(li);
        });
    }

    const loadModalElement = document.getElementById('loadModal');
    if (!loadModalElement) {
        console.error('loadModal element not found. Please ensure the modal HTML is correct.');
        return;
    }

    const loadModal = new bootstrap.Modal(loadModalElement);
    loadModal.show();

    // Add event listeners for Load buttons
    document.querySelectorAll('.load-data-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const index = btn.getAttribute('data-index');
            loadData(index);
            loadModal.hide();
        });
    });

    // Add event listeners for Delete buttons
    document.querySelectorAll('.delete-data-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const index = btn.getAttribute('data-index');
            deleteData(index);
            loadModal.hide();
            showLoadModal();
        });
    });

    // Add event listener for file input
    const fileInput = document.getElementById('loadJsonFile');
    if (fileInput) {
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    // Add the loaded data to localStorage to make it available for loading
                    let savedData = JSON.parse(localStorage.getItem('preCostingSavedData')) || [];
                    savedData.push(jsonData);
                    localStorage.setItem('preCostingSavedData', JSON.stringify(savedData));

                    // Refresh the modal to show the newly added data
                    loadModal.hide();
                    showLoadModal();

                    // Optionally, load the data immediately
                    loadData(savedData.length - 1);
                } catch (error) {
                    console.error('Error parsing JSON file:', error);
                    alert('Failed to load JSON file. Please ensure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);
        });
    }
}

function deleteData(index) {
    let savedData = JSON.parse(localStorage.getItem('preCostingSavedData')) || [];
    if (index >= 0 && index < savedData.length) {
        savedData.splice(index, 1); // Remove the entry at the specified index
        localStorage.setItem('preCostingSavedData', JSON.stringify(savedData));
        // alert('Data deleted successfully!');
    } else {
        alert('Error: Data not found.');
    }
}

function loadData(index) {
    const savedData = JSON.parse(localStorage.getItem('preCostingSavedData')) || [];
    const data = savedData[index];
    if (!data) {
        alert('No data found to load.');
        return;
    }

    // Construct currentPreCostingData in the same format as Supabase data
    const preCostingData = {
        pre_costing_no: data.preCostingNo,
        buyer: data.buyer || '',
        construction: data.construction || '',
        finish_width: data.finishWidth || 0,
        total_ends: data.totalEnds || 0,
        warp_crimp: data.warpCrimp || 0,
        yd_allow: data.ydAllow || 0,
        warp_wast: data.warpWast || 0,
        weft_wast: data.weftWast || 0,
        finish_allow: data.finishAllow || 0,
        weaving_rate: data.weavingPickRate || 0,
        dye_finish_rate: data.dyeingFinishingRate || 0,
        commercial_cost: data.commercialCostInput || 0,
        profit: data.profit || 0,
        order_quantity: data.orderQuantity || 0,
        pick_length: data.pickLength || 0,
        pre_costing_date: data.preCostingDate || '',
        dollar_rate_tk: data.dollarRateTk || 0,
        epi: data.epi || 0,
        ppi: data.ppi || 0,
        weave_type: data.weaveType || '',
        weft_crimp: data.weftCrimp || 0,
        greige_width: data.greigeWidth || 0,
        // Add fields that are typically populated after calculation
        greige_req_quantity: 0, // These will be recalculated
        required_warp_yarn: 0,
        required_weft_yarn: 0,
        total_required_yarn: 0,
        warp_greige_consump: 0,
        weft_greige_consump: 0,
        total_greige_consump: 0,
        warp_finish_consump: 0,
        weft_finish_consump: 0,
        total_finish_consump: 0,
        total_greige_yarn_cost_per_yd: 0,
        warp_yarn_cost: 0,
        weft_yarn_cost: 0,
        greige_cost: 0,
        yarn_dyeing_cost: 0,
        total_yarn_cost: 0,
        weaving_cost: 0,
        break_even_cost: 0,
        sales_price: 0,
        upcharged_sales_price: 0,
        total_warp_cost: 0,
        total_weft_cost: 0,
        total_greige_cost: 0,
        total_dyeing_cost: 0,
        total_weaving_cost: 0,
        total_dye_finish_cost: 0,
        total_commercial_cost: 0,
        grand_total_break_even_cost: 0,
        net_break_even_cost_per_yd: 0,
        net_profit_per_yd: 0,
        grand_total_profit: 0,
        total_sales_value: 0,
        upcharged_net_profit_per_yd: 0,
        upcharged_grand_total_profit: 0,
        upcharged_total_sales_value: 0,
        total_pre_cost_tk: 0,
        total_pre_cost_usd: 0,
        total_upcharged_pre_cost_tk: 0,
        total_upcharged_pre_cost_usd: 0
    };

    const warpDetails = (data.warpDetails || []).map(detail => ({
        pre_costing_no: data.preCostingNo,
        warp_count: detail.count || 0,
        repeat_breakdown: detail.repeatBreakdown || 0,
        color_name: detail.colorName || '',
        denting: detail.denting || 0,
        rate_per_lbs: detail.ratePerLbs || 0,
        dyeing_cost_per_kg: detail.dyeingCostPerKg || 0,
        repeat_ends_per_color: 0, // Will be recalculated
        pattern_total_ends: 0,
        dent_numbers_in_full_width: 0,
        greige_yarn_rate: 0,
        consumption: 0,
        yarn_cost: 0,
        color_cost: 0,
        warp_total_cost: 0,
        required_greige: 0
    }));

    const weftDetails = (data.weftDetails || []).map(detail => ({
        pre_costing_no: data.preCostingNo,
        weft_count: detail.count || 0,
        repeat_breakdown: detail.repeatBreakdown || 0,
        color_name: detail.colorName || '',
        pick_density: detail.pickDensity || 0,
        rate_per_lbs: detail.ratePerLbs || 0,
        dyeing_cost_per_kg: detail.dyeingCostPerKg || 0,
        repeat_picks_per_color: 0, // Will be recalculated
        pattern_total_picks: 0,
        greige_yarn_rate: 0,
        consumption: 0,
        yarn_cost: 0,
        color_cost: 0,
        weft_total_cost: 0,
        required_greige: 0
    }));

    // Populate currentPreCostingData
    currentPreCostingData = {
        preCostingData: preCostingData,
        warpDetails: warpDetails,
        weftDetails: weftDetails
    };

    // Autofill input fields with the full preCostingNo format
    document.getElementById('preCostingNo').value = data.preCostingNo; // Use the full format
    document.getElementById('buyer').value = data.buyer || '';
    document.getElementById('construction').value = data.construction || '';
    document.getElementById('finishWidth').value = data.finishWidth || '';
    document.getElementById('totalEnds').value = data.totalEnds || '';
    document.getElementById('warpCrimp').value = data.warpCrimp || '';
    document.getElementById('ydAllow').value = data.ydAllow || '';
    document.getElementById('warpWast').value = data.warpWast || '';
    document.getElementById('weftWast').value = data.weftWast || '';
    document.getElementById('finishAllow').value = data.finishAllow || '';
    document.getElementById('weavingPickRate').value = data.weavingPickRate || '';
    document.getElementById('dyeingFinishingRate').value = data.dyeingFinishingRate || '';
    document.getElementById('commercialCostInput').value = data.commercialCostInput || '';
    document.getElementById('profit').value = data.profit || '';
    document.getElementById('orderQuantity').value = data.orderQuantity || '';
    document.getElementById('pickLength').value = data.pickLength || '';
    document.getElementById('preCostingDate').value = data.preCostingDate || '';
    document.getElementById('dollarRateTk').value = data.dollarRateTk || '';
    document.getElementById('epi').value = data.epi || '';
    document.getElementById('ppi').value = data.ppi || '';
    document.getElementById('weaveType').value = data.weaveType || '';
    document.getElementById('weftCrimp').value = data.weftCrimp || '';
    document.getElementById('greigeWidth').value = data.greigeWidth || '';

    // Repopulate Warp and Weft tables
    const warpTbody = document.getElementById('warpCalculationTable').querySelector('tbody');
    const weftTbody = document.getElementById('weftCalculationTable').querySelector('tbody');
    warpTbody.innerHTML = '';
    weftTbody.innerHTML = '';

    if (data.warpDetails && data.warpDetails.length > 0) {
        data.warpDetails.forEach(warpDetail => {
            const newRow = document.createElement('tr');
            newRow.className = 'pattern-row';
            newRow.innerHTML = `
                <td><input type="number" class="form-control" value="${warpDetail.count || ''}"></td>
                <td><input type="number" class="form-control" value="${warpDetail.repeatBreakdown || ''}"></td>
                <td><input type="text" class="form-control" value="${warpDetail.colorName || ''}"></td>
                <td><input type="number" class="form-control" value="${warpDetail.denting || ''}"></td>
                <td><input type="number" class="form-control" value="${warpDetail.ratePerLbs || ''}"></td>
                <td><input type="number" class="form-control" value="${warpDetail.dyeingCostPerKg || ''}"></td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.0</td>
                <td class="result-cell">0.0000</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
            `;
            warpTbody.appendChild(newRow);
        });
    } else {
        addEmptyWarpRow(warpTbody);
    }

    if (data.weftDetails && data.weftDetails.length > 0) {
        data.weftDetails.forEach(weftDetail => {
            const newRow = document.createElement('tr');
            newRow.className = 'pattern-row';
            newRow.innerHTML = `
                <td><input type="number" class="form-control" value="${weftDetail.count || ''}"></td>
                <td><input type="number" class="form-control" value="${weftDetail.repeatBreakdown || ''}"></td>
                <td><input type="text" class="form-control" value="${weftDetail.colorName || ''}"></td>
                <td><input type="number" class="form-control" value="${weftDetail.pickDensity || ''}"></td>
                <td><input type="number" class="form-control" value="${weftDetail.ratePerLbs || ''}"></td>
                <td><input type="number" class="form-control" value="${weftDetail.dyeingCostPerKg || ''}"></td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.0</td>
                <td class="result-cell">0.0000</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td class="result-cell">0.00</td>
                <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
            `;
            weftTbody.appendChild(newRow);
        });
    } else {
        addEmptyWeftRow(weftTbody);
    }

    calculateForm();
}

// Add empty warp row
function addEmptyWarpRow(tbody) {
    const newRow = document.createElement('tr');
    newRow.className = 'pattern-row';
    newRow.innerHTML = `
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="text" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.0</td>
        <td class="result-cell">0.0000</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
    `;
    tbody.appendChild(newRow);
    calculateForm(); // Recalculate to ensure total row is updated and positioned correctly
}

// Add empty weft row
function addEmptyWeftRow(tbody) {
    const newRow = document.createElement('tr');
    newRow.className = 'pattern-row';
    newRow.innerHTML = `
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="text" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td><input type="number" class="form-control" value=""></td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.0</td>
        <td class="result-cell">0.0000</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td class="result-cell">0.00</td>
        <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
    `;
    tbody.appendChild(newRow);
    calculateForm(); // Recalculate to ensure total row is updated and positioned correctly
}

// Initialize tables with one empty row each
document.addEventListener('DOMContentLoaded', () => {
    const warpTbody = document.getElementById('warpCalculationTable')?.querySelector('tbody');
    const weftTbody = document.getElementById('weftCalculationTable')?.querySelector('tbody');
    if (warpTbody && warpTbody.children.length === 0) {
        addEmptyWarpRow(warpTbody);
    }
    if (weftTbody && weftTbody.children.length === 0) {
        addEmptyWeftRow(weftTbody);
    }
});
</script>
</body>
</html>
